---
layout: post
title: Nix secrets for dummies
date: 2024-07-12 10:25 -0700
excerpt_separator: <!--more-->
---

Despite having used Nix for several years already, I feel secure in admitting that new concepts in Nix continue to be confusing at first glance.

I had avoided doing any _secret management_ for Nix for a long time, largely because I ran Nix atop another Linux distribution, but now that I'm on NixOS _my time hath come_.

I wanted to write out my learnings here so that others may benefit from the _ELI5_ style of learning that we are missing in Nix.

<!--more-->

Doing any basic Google-fu lands on two solutions for Nix for secret management: [agenix](https://github.com/ryantm/agenix) or [sops-nix](https://github.com/Mic92/sops-nix).

Let me save you time, and we will focus solely on _agenix_. _agenix_ is a Nix module + helpful tooling built around [age](https://github.com/FiloSottile/age).

We will work around the example of a secret file: _password_

```
‚ùØ echo "swordfish" > password
‚ùØ cat password
swordfish
```

age's popularity is all centered around it's minimalism and ease-of-use.

You encrypt files in _age_ with "recipients" (public-keys) and decrypt them with "identifies" (private-keys). 

‚ùóYou can encrypt a file for multiple recipients but **any single one** can decrypt the file. This will prove to be useful for _agenix_.

```console
‚ùØ age --armor \
    -r age1yubikey1qg8nf40dfw4gprmywplggtg2wuvv55fcmujzrm65z8s3j6rhwje2vm3hhs7 \
    password > password.age

‚ùØ cat password.age 
-----BEGIN AGE ENCRYPTED FILE-----
YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IHBpdi1wMjU2IGVUczBkQSBBeEIwTlVC
TE1ZU3dhS1I4UlphT1dhaXNUY2Z2L1pLaWUxS0dwZFB6V0x4VApLWCs5R2hjY3JT
V2RxTk13RFE0bDNRZXZ1NVJWUzhrQm05dlNsSTN2eSs0Ci0tLSB4eUpVaC9FUm56
OEJQaVp0aEFRS2VZSlJQYWl0dGU5a2dpYVhOb2hsN05NCprozK/msLjTafWAkrSe
+wYeAyI82vEwa0d5MO/CZzxwixKlRKbzZ2flKg==
-----END AGE ENCRYPTED FILE-----
```

> recipients can be an age public key generated by age-keygen ("age1..."), an SSH public key ("ssh-ed25519 AAAA...", "ssh-rsa AAAA...") or even a private key stored on a Yubikey using [age-plugin-yubikey](https://github.com/str4d/age-plugin-yubikey).


_How does this all fit in with NixOS ?_

The goal is to get an encrypted secret from one machine to another.
_agenix_ takes advantage of the fact that most systems built with NixOS have a default host key generated via [services.openssh.hostKeys](https://search.nixos.org/options?channel=unstable&show=services.openssh.hostKeys&from=0&size=50&sort=relevance&type=packages&query=services.openssh.hostKeys).

ü§î We can encrypt our secret with our own personal key and the keys of any machine we'd like to deploy to. Any single key can decrypt the secret.

_agenix_ sets up the mapping of which keys to use to encrypt each secret via the file _secrets.nix_

> I found the [installation instructions](https://github.com/ryantm/agenix?tab=readme-ov-file#installation) for _agenix_ great so they are not covered here.

```nix
let
  # put the machine you want to deploy to here
  systems = {
    nyx = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOXmzOre8wnaZm4zXuXqzFRS+5GFlMyfhth9ie9AvW8t root@nyx";
  };
  # put which users should also be able to decrypt the secret
  users = {
    fmzakari-yubikey = "age1yubikey1qg8nf40dfw4gprmywplggtg2wuvv55fcmujzrm65z8s3j6rhwje2vm3hhs7";
  };
  allUsers = builtins.attrValues users;
  allSystems = builtins.attrValues systems;
in {
  "password.age".publicKeys = allUsers ++ [systems.nyx];
}
```

You run it with `agenix -e <FILE>` where _FILE_ is one of the keys in the attrset in _secrets.nix_.

ü§î This mapping is not specific to Nix and could even be a TOML file with a very minimal _secrets.nix_

```toml
["password.age"]
publicKeys = [
  "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOXmzOre8wnaZm4zXuXqzFRS+5GFlMyfhth9ie9AvW8t"
  "age1yubikey1qg8nf40dfw4gprmywplggtg2wuvv55fcmujzrm65z8s3j6rhwje2vm3hhs7"
]
```

```nix
builtins.fromTOML (builtins.readFile ./secrets.toml)
```

‚ùó You don't even have to use the _agenix_ CLI tool if you want to just list the recipients yourself and use _age_ to encrypt secrets.

You should now have _password.age_. Feel free to commit this to your repository.

How do we make use of this secret? That's where the _agenix_ NixOS module comes into play.

Simply, declare which secrets you want to try to decrypt. agenix will use the **target machine's** SSH public key to decrypt the secret.

_Remember we encrypted the secret with host keys of the machines that could decrypt it!_

```nix
  age.secrets = {
    "password" = {
      # change to whatever path it is in your NixOS configuration
      file = ./secrets/password.age;
    };
  };
```

After you deploy your NixOS configuration, you can find the secret at _/run/agenix_ decrypted at switch time via an activation script.

```console
‚ùØ sudo ls /run/agenix/
password
```

You can read from the filesystem or reference this path in Nix itself.

```nix
${config.age.secrets."password".path}
```

üéÜ You now have unlocked a new level in NixOS: _Secret Management_.

If you think this post can be improved [please let me know](mailto:farid.m.zakaria@gmail.com)