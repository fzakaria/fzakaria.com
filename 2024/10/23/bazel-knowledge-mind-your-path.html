<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Bazel Knowledge: mind your PATH | Farid Zakaria‚Äôs Blog</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Bazel Knowledge: mind your PATH" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Have you encountered the following? &gt; bazel build INFO: Invocation ID: f16c3f83-0150-494e-bd34-1a9cfb6a2e67 WARNING: Build option --incompatible_strict_action_env has changed, discarding analysis cache (this can be expensive, see https://bazel.build/advanced/performance/iteration-speed). INFO: Analyzed target @@com_google_protobuf//:protoc (113 packages loaded, 1377 targets configured). [483 / 845] 13 actions, 12 running Compiling src/google/protobuf/compiler/importer.cc; 3s disk-cache, darwin-sandbox Compiling src/google/protobuf/compiler/java/names.cc; 1s disk-cache, darwin-sandbox Compiling src/google/protobuf/compiler/java/name_resolver.cc; 1s disk-cache, darwin-sandbox Compiling src/google/protobuf/compiler/java/helpers.cc; 1s disk-cache, darwin-sandbox Compiling src/google/protobuf/compiler/objectivec/enum.cc; 1s disk-cache, darwin-sandbox Compiling absl/strings/cord.cc; 1s disk-cache, darwin-sandbox Compiling src/google/protobuf/compiler/objectivec/names.cc; 0s disk-cache, darwin-sandbox Compiling absl/time/internal/cctz/src/time_zone_lookup.cc; 0s disk-cache, darwin-sandbox ... I finally had it with Bazel recompiling protoc üò§ The working title for this post: Why the #$@! does protoc keep recompiling! ü§¨ If you are not interested in the story and just want to avoid recompiling protoc, try putting build --incompatible_strict_action_env in your .bazelrc. Checkout Aspect‚Äôs bazelrc guide for other good tidbits." />
<meta property="og:description" content="Have you encountered the following? &gt; bazel build INFO: Invocation ID: f16c3f83-0150-494e-bd34-1a9cfb6a2e67 WARNING: Build option --incompatible_strict_action_env has changed, discarding analysis cache (this can be expensive, see https://bazel.build/advanced/performance/iteration-speed). INFO: Analyzed target @@com_google_protobuf//:protoc (113 packages loaded, 1377 targets configured). [483 / 845] 13 actions, 12 running Compiling src/google/protobuf/compiler/importer.cc; 3s disk-cache, darwin-sandbox Compiling src/google/protobuf/compiler/java/names.cc; 1s disk-cache, darwin-sandbox Compiling src/google/protobuf/compiler/java/name_resolver.cc; 1s disk-cache, darwin-sandbox Compiling src/google/protobuf/compiler/java/helpers.cc; 1s disk-cache, darwin-sandbox Compiling src/google/protobuf/compiler/objectivec/enum.cc; 1s disk-cache, darwin-sandbox Compiling absl/strings/cord.cc; 1s disk-cache, darwin-sandbox Compiling src/google/protobuf/compiler/objectivec/names.cc; 0s disk-cache, darwin-sandbox Compiling absl/time/internal/cctz/src/time_zone_lookup.cc; 0s disk-cache, darwin-sandbox ... I finally had it with Bazel recompiling protoc üò§ The working title for this post: Why the #$@! does protoc keep recompiling! ü§¨ If you are not interested in the story and just want to avoid recompiling protoc, try putting build --incompatible_strict_action_env in your .bazelrc. Checkout Aspect‚Äôs bazelrc guide for other good tidbits." />
<link rel="canonical" href="https://fzakaria.com/2024/10/23/bazel-knowledge-mind-your-path.html" />
<meta property="og:url" content="https://fzakaria.com/2024/10/23/bazel-knowledge-mind-your-path.html" />
<meta property="og:site_name" content="Farid Zakaria‚Äôs Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-10-23T15:37:00-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bazel Knowledge: mind your PATH" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-10-23T15:37:00-07:00","datePublished":"2024-10-23T15:37:00-07:00","description":"Have you encountered the following? &gt; bazel build INFO: Invocation ID: f16c3f83-0150-494e-bd34-1a9cfb6a2e67 WARNING: Build option --incompatible_strict_action_env has changed, discarding analysis cache (this can be expensive, see https://bazel.build/advanced/performance/iteration-speed). INFO: Analyzed target @@com_google_protobuf//:protoc (113 packages loaded, 1377 targets configured). [483 / 845] 13 actions, 12 running Compiling src/google/protobuf/compiler/importer.cc; 3s disk-cache, darwin-sandbox Compiling src/google/protobuf/compiler/java/names.cc; 1s disk-cache, darwin-sandbox Compiling src/google/protobuf/compiler/java/name_resolver.cc; 1s disk-cache, darwin-sandbox Compiling src/google/protobuf/compiler/java/helpers.cc; 1s disk-cache, darwin-sandbox Compiling src/google/protobuf/compiler/objectivec/enum.cc; 1s disk-cache, darwin-sandbox Compiling absl/strings/cord.cc; 1s disk-cache, darwin-sandbox Compiling src/google/protobuf/compiler/objectivec/names.cc; 0s disk-cache, darwin-sandbox Compiling absl/time/internal/cctz/src/time_zone_lookup.cc; 0s disk-cache, darwin-sandbox ... I finally had it with Bazel recompiling protoc üò§ The working title for this post: Why the #$@! does protoc keep recompiling! ü§¨ If you are not interested in the story and just want to avoid recompiling protoc, try putting build --incompatible_strict_action_env in your .bazelrc. Checkout Aspect‚Äôs bazelrc guide for other good tidbits.","headline":"Bazel Knowledge: mind your PATH","mainEntityOfPage":{"@type":"WebPage","@id":"https://fzakaria.com/2024/10/23/bazel-knowledge-mind-your-path.html"},"url":"https://fzakaria.com/2024/10/23/bazel-knowledge-mind-your-path.html"}</script>
<!-- End Jekyll SEO tag -->

        <link type="application/atom+xml" rel="alternate" href="https://fzakaria.com/feed.xml" title="Farid Zakaria&apos;s Blog" />
        <link rel="stylesheet" type="text/css" href="/assets/css/base.css">
        <link rel="icon" type="image/x-icon" href="/assets/images/avatar.ico">
        <link rel="alternate" type="application/atom+xml" title="Farid Zakaria's Blog" href="/feed.xml">

        <link ref="">

        
        

        
            <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-35360900-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-35360900-1');
</script>

        

    </head>
    <body>
        

        <div class="container">
            <h1 class="page-title">
    <a class="rss pull-right" href="/feed.xml"><i class="fa fa-rss"></i></a>
    Bazel Knowledge: mind your PATH
</h1>

<div class="content">
    
    <p class="date">
        Published 2024-10-23
        on <a href="/">Farid Zakaria's Blog</a>
        <span class="hidden-xs">
          &mdash;
          <a href="/2024/10/23/bazel-knowledge-mind-your-path.html">
            Permalink
          </a>
        </span>
    </p>
    
    <article>
      <p>Have you encountered the following?</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> bazel build
INFO: Invocation ID: f16c3f83-0150-494e-bd34-1a9cfb6a2e67
WARNING: Build option <span class="nt">--incompatible_strict_action_env</span> has changed, discarding analysis cache <span class="o">(</span>this can be expensive, see https://bazel.build/advanced/performance/iteration-speed<span class="o">)</span><span class="nb">.</span>
INFO: Analyzed target @@com_google_protobuf//:protoc <span class="o">(</span>113 packages loaded, 1377 targets configured<span class="o">)</span><span class="nb">.</span>
<span class="o">[</span>483 / 845] 13 actions, 12 running
    Compiling src/google/protobuf/compiler/importer.cc<span class="p">;</span> 3s disk-cache, darwin-sandbox
    Compiling src/google/protobuf/compiler/java/names.cc<span class="p">;</span> 1s disk-cache, darwin-sandbox
    Compiling src/google/protobuf/compiler/java/name_resolver.cc<span class="p">;</span> 1s disk-cache, darwin-sandbox
    Compiling src/google/protobuf/compiler/java/helpers.cc<span class="p">;</span> 1s disk-cache, darwin-sandbox
    Compiling src/google/protobuf/compiler/objectivec/enum.cc<span class="p">;</span> 1s disk-cache, darwin-sandbox
    Compiling absl/strings/cord.cc<span class="p">;</span> 1s disk-cache, darwin-sandbox
    Compiling src/google/protobuf/compiler/objectivec/names.cc<span class="p">;</span> 0s disk-cache, darwin-sandbox
    Compiling absl/time/internal/cctz/src/time_zone_lookup.cc<span class="p">;</span> 0s disk-cache, darwin-sandbox ...
</code></pre></div></div>

<p>I finally had it with Bazel <strong>recompiling protoc</strong> üò§</p>

<p>The working title for this post: <em>Why the #$@! does protoc keep recompiling!</em> ü§¨</p>

<blockquote>
  <p>If you are not interested in the story and just want to avoid recompiling <em>protoc</em>, try putting <code class="language-plaintext highlighter-rouge">build --incompatible_strict_action_env</code> in your <em>.bazelrc</em>.</p>

  <p>Checkout Aspect‚Äôs <a href="https://docs.aspect.build/guides/bazelrc/">bazelrc guide</a> for other good tidbits.</p>
</blockquote>

<!--more-->

<p>Admittedly, I‚Äôve been using Bazel a while and I wasn‚Äôt sure why I kept having to rebuild <em>protoc</em> despite nothing seemingly changing on my system.</p>

<p>Worse, my coworkers who I‚Äôve been working hard to champion Bazel were starting to notice.</p>

<p><em>‚ÄúYou explained that Bazel is supposed to be hermetic and have great caching. Why am I recompiling protoc?‚Äù</em></p>

<p>This seems to be a bit of an issue within the Bazel community so much so, that one recommended approach is just <em>use precompiled binaries</em> via <a href="https://github.com/aspect-build/toolchains_protoc">aspect-build/toolchains_protoc</a>. ü§¶</p>

<blockquote>
  <p><em>Aside</em>: Using prebuilt binaries not only hinders my own personal adoption of Bazel on <a href="https://nixos.org">NixOS</a> but devalues the value proposition of Bazel itself.</p>
</blockquote>

<p>Turns out there is a long-standing <strong>5 year old</strong> issue <a href="https://github.com/bazelbuild/bazel/issues/7095">issues#7095</a> that provided some clues; specifically changing <code class="language-plaintext highlighter-rouge">PATH</code> is busting the action key.</p>

<p>I want to validate this assumption, by following the guide on <a href="https://bazel.build/remote/cache-remote">how to debug remote cache hits</a>.</p>

<p>I ran Bazel twice, once with a different <code class="language-plaintext highlighter-rouge">PATH</code> and stored the compact execution log.
I then convert it to textual form and diff them.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># build protoc normally</span>
<span class="o">&gt;</span> bazel build @com_google_protobuf//:protoc <span class="se">\</span>
    <span class="nt">--execution_log_compact_file</span><span class="o">=</span>/tmp/exec1.log

<span class="c"># muck up the PATH</span>
<span class="o">&gt;</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/bin4/ bazel build @com_google_protobuf//:protoc <span class="se">\</span>
    <span class="nt">--execution_log_compact_file</span><span class="o">=</span>/tmp/exec2.log

<span class="o">&gt;</span> bazel-bin/src/tools/execlog/parser <span class="se">\</span>
  <span class="nt">--log_path</span><span class="o">=</span>/tmp/exec1.log <span class="se">\</span>
  <span class="nt">--log_path</span><span class="o">=</span>/tmp/exec2.log <span class="se">\</span>
  <span class="nt">--output_path</span><span class="o">=</span>/tmp/exec1.log.txt <span class="se">\</span>
  <span class="nt">--output_path</span><span class="o">=</span>/tmp/exec2.log.txt

<span class="o">&gt;</span> diff /tmp/exec1.log.txt /tmp/exec2.log.txt | <span class="nb">head</span> <span class="nt">-n</span> 30
<span class="c"># omitted for brevity</span>
</code></pre></div></div>

<p>Sure enough; there is an <code class="language-plaintext highlighter-rouge">action_env</code> with the <code class="language-plaintext highlighter-rouge">PATH</code> variable and it‚Äôs different, causing the action digest to change.</p>

<p>But, why! ü§î</p>

<p>Some of the actions used in the C++ toolchain use the shell‚Äôs default environment.
For instance, Bazel doesn‚Äôt include a C++ toolchain by default so it has to find a C++ compiler by searching
on the <code class="language-plaintext highlighter-rouge">PATH</code> itself.</p>

<p>We can test this (thanks to <a href="https://github.com/keith">keith</a> for this) with a small demo.
We can see what envs are in actions by default passing <code class="language-plaintext highlighter-rouge">-s</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">actions</span><span class="p">.</span><span class="n">declare_file</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">label</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">actions</span><span class="p">.</span><span class="n">run_shell</span><span class="p">(</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">file</span><span class="p">],</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s">"touch {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">file</span><span class="p">.</span><span class="n">path</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">DefaultInfo</span><span class="p">(</span><span class="n">files</span> <span class="o">=</span> <span class="n">depset</span><span class="p">([</span><span class="nb">file</span><span class="p">]))</span>

<span class="n">foo</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span>
    <span class="n">implementation</span> <span class="o">=</span> <span class="n">_impl</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Will produce:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SUBCOMMAND: <span class="c"># //:bar [action 'Action bar', configuration: 815f76489fb61a0245ff1941974c20af0ca4e7f91caa00c80538d4493d650289, execution platform: @@platforms//host:host, mnemonic: Action]</span>
<span class="o">(</span><span class="nb">cd</span> /home/ubuntu/.cache/bazel/_bazel_ubuntu/1275a810ad76d4d1cc60319d4aaf0d39/execroot/_main <span class="o">&amp;&amp;</span> <span class="se">\</span>
  <span class="nb">exec env</span> - <span class="se">\</span>
  /bin/bash <span class="nt">-c</span> <span class="s1">'touch bazel-out/aarch64-fastbuild/bin/bar'</span><span class="o">)</span>
</code></pre></div></div>

<p>If we change the <code class="language-plaintext highlighter-rouge">run_shell</code> action to use <code class="language-plaintext highlighter-rouge">use_default_shell_env=True</code> we then get.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SUBCOMMAND: <span class="c"># //:bar [action 'Action bar', configuration: 815f76489fb61a0245ff1941974c20af0ca4e7f91caa00c80538d4493d650289, execution platform: @@platforms//host:host, mnemonic: Action]</span>
<span class="o">(</span><span class="nb">cd</span> /home/ubuntu/.cache/bazel/_bazel_ubuntu/1275a810ad76d4d1cc60319d4aaf0d39/execroot/_main <span class="o">&amp;&amp;</span> <span class="se">\</span>
  <span class="nb">exec env</span> - <span class="se">\</span>
    <span class="nv">PATH</span><span class="o">=</span>&lt;OMITTED FOR BREVITY&gt; <span class="se">\</span>
  /bin/bash <span class="nt">-c</span> <span class="s1">'touch bazel-out/aarch64-fastbuild/bin/bar'</span><span class="o">)</span>
</code></pre></div></div>

<p>Okay, so how do we solve this?</p>

<p>There are two ways to solve this.</p>

<p>First, you can try <code class="language-plaintext highlighter-rouge">--incompatible_strict_action_env</code> in your <em>.bazerc</em> file.
If this flag is set, Bazel will force set <code class="language-plaintext highlighter-rouge">PATH</code> to be a static value. If your C++ compiler is either a hermetic toolchain or found in the default lists set; you are good to go!</p>

<p>If you tried the first option but your build is failing, you‚Äôll have to manually force set the <code class="language-plaintext highlighter-rouge">PATH</code> via the <code class="language-plaintext highlighter-rouge">action_env</code> flag such as <code class="language-plaintext highlighter-rouge">--action_env=PATH=/usr/bin:/something/custom</code></p>

<p>Hopefully these settings get you from recompiling <em>protoc</em> and reach Bazel nirvana.</p>

<p>I highly recommend <a href="https://docs.aspect.build/guides/bazelrc/">Aspect‚Äôs bazelrc guide</a> for other no-nonsense settings that should likely just be the default üôÑ</p>


<hr />
    </article>
</div>

<div class="sidebar">
    <hr class="visible-xs" />
    <img class="avatar" src="/assets/images/avatar-164.png" alt="A photo of my dog Moose" title="My dog Moose"/>
    <p>I'm a software engineer, father and wishful amateur surfer. If you've come seeking my political views; you've found the wrong <a href="https://fareedzakaria.com/">Fareed</a>.</p>
    <div class="external-links">
      <p>
        <span class="context">linkedin</span>
        <a href="https://www.linkedin.com/in/fmzakari/">fmzakari</a>
      </p>
      <p>
        <span class="context">github</span>
        <a href="https://github.com/fzakaria">fzakaria</a>
      </p>
      <p>
        <span class="context">email</span>
        <a href="mailto:farid.m.zakaria@gmail.com">farid.m.zakaria@gmail.com</a>
      </p>
      <p>
        <span class="context">pgp</span>
        <a href="/publickey.txt">D1B232E7</a>
      </p>
      <p>
        <a href="/archive">Archive</a>
      </p>
      <p>
        <a href="/old_blog/">Historic WordPress Blog</a>
      </p>
      <!--
      <p>
        Web friendly version of my <a href="/resume/index.html">resume</a>.
      </p>
    </div>
    <h3>Projects</h3>
    <p>
      <a href="/projects/">Click here</a> for some personal
      projects I've worked on.
    </p>
    <h3>Old Blog</h3>
    <p>
      <a href="/old_blog/">Click here</a> for the archive
      of my old blog posts from Wordpress.
    </p>
    -->
    
    <h3>Recent Posts</h3>
    
    <div class="post-stub">
      2025-02-02<br />
      <a href="/2025/02/02/nix-string-interpolation-of-directories-gone-awry.html">Nix: string interpolation of directories gone awry</a>
    </div>
    
    <div class="post-stub">
      2025-01-28<br />
      <a href="/2025/01/28/bazel-build-event-protocol-viewer.html">Bazel: Build Event Protocol Viewer</a>
    </div>
    
    <div class="post-stub">
      2025-01-12<br />
      <a href="/2025/01/12/bazel-knowledge-be-mindful-of-build-without-the-bytes.html">Bazel Knowledge: Be mindful of Build Without the Bytes (bwob)</a>
    </div>
    
    
    <h3>License</h3>
    <p style="font-size: 10pt">
    The content for this site is
    <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>.
    The <a href="https://github.com/SirCmpwn/ddjekyll">inspiration for the theme</a> for this site is
    ¬© Drew Devault.
    </p>
    <div class="spacer" style="margin-top: 30px;"></div>
    
    <p><a href="https://github.com/fzakaria/fzakaria.com/edit/master/_posts/2024-10-23-bazel-knowledge-mind-your-path.md">
      Improve this page @ 417ff2d
    </a></p>

</div>
        </div>
    </body>
</html>
