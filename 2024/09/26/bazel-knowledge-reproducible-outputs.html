<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Bazel Knowledge: reproducible outputs | Farid Zakaria‚Äôs Blog</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Bazel Knowledge: reproducible outputs" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="You might hear a lot of about how Bazel is ‚Äúreproducible‚Äù and ‚Äúhermetic‚Äù, but what does that even mean ? üòï Part of what makes Bazel incredibly fast is it effectively skips work by foregoing doing portions of the graph if the inputs have not changed. Let‚Äôs consider this simple action graph in Bazel." />
<meta property="og:description" content="You might hear a lot of about how Bazel is ‚Äúreproducible‚Äù and ‚Äúhermetic‚Äù, but what does that even mean ? üòï Part of what makes Bazel incredibly fast is it effectively skips work by foregoing doing portions of the graph if the inputs have not changed. Let‚Äôs consider this simple action graph in Bazel." />
<link rel="canonical" href="https://fzakaria.com/2024/09/26/bazel-knowledge-reproducible-outputs.html" />
<meta property="og:url" content="https://fzakaria.com/2024/09/26/bazel-knowledge-reproducible-outputs.html" />
<meta property="og:site_name" content="Farid Zakaria‚Äôs Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-09-26T11:50:00-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bazel Knowledge: reproducible outputs" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-09-26T11:50:00-07:00","datePublished":"2024-09-26T11:50:00-07:00","description":"You might hear a lot of about how Bazel is ‚Äúreproducible‚Äù and ‚Äúhermetic‚Äù, but what does that even mean ? üòï Part of what makes Bazel incredibly fast is it effectively skips work by foregoing doing portions of the graph if the inputs have not changed. Let‚Äôs consider this simple action graph in Bazel.","headline":"Bazel Knowledge: reproducible outputs","mainEntityOfPage":{"@type":"WebPage","@id":"https://fzakaria.com/2024/09/26/bazel-knowledge-reproducible-outputs.html"},"url":"https://fzakaria.com/2024/09/26/bazel-knowledge-reproducible-outputs.html"}</script>
<!-- End Jekyll SEO tag -->

        <link type="application/atom+xml" rel="alternate" href="https://fzakaria.com/feed.xml" title="Farid Zakaria&apos;s Blog" />
        <link rel="stylesheet" type="text/css" href="/assets/css/base.css">
        <link rel="icon" type="image/x-icon" href="/assets/images/avatar.ico">
        <link rel="alternate" type="application/atom+xml" title="Farid Zakaria's Blog" href="/feed.xml">

        <link ref="">

        
        

        
            <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-35360900-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-35360900-1');
</script>

        

    </head>
    <body>
        

        <div class="container">
            <h1 class="page-title">
    <a class="rss pull-right" href="/feed.xml"><i class="fa fa-rss"></i></a>
    Bazel Knowledge: reproducible outputs
</h1>

<div class="content">
    
    <p class="date">
        Published 2024-09-26
        on <a href="/">Farid Zakaria's Blog</a>
        <span class="hidden-xs">
          &mdash;
          <a href="/2024/09/26/bazel-knowledge-reproducible-outputs.html">
            Permalink
          </a>
        </span>
    </p>
    
    <article>
      <p>You might hear a lot of about how Bazel is <em>‚Äúreproducible‚Äù</em> and <em>‚Äúhermetic‚Äù</em>, but what does that even mean ? üòï</p>

<p>Part of what makes Bazel incredibly fast is it effectively <strong>skips work</strong> by foregoing doing portions of the graph if the inputs have not changed.</p>

<p>Let‚Äôs consider this simple action graph in Bazel.</p>

<p><img src="/assets/images/action_graph_bazel.png" alt="Bazel Action Graph" /></p>

<!--more-->

<p>Bazel constructs an <a href="https://bazel.build/reference/glossary#action-cache">action key</a> for each action which we can simplify down to constituting: the Starlark of the action itself &amp; the SHA256 of the outputs of all the dependencies (i.e. srcs or deps).</p>

<p>Let‚Äôs consider a change to <em>File D</em>, which would mean that the action key for <em>Action C</em> now differs.</p>

<p>At this point Bazel will decide to rerun <em>Action C</em> and will produce an output <em>SHA256-C</em>.</p>

<p>If the <em>SHA256-C</em> is the exact same as before, Bazel <strong>will forgoe</strong> executing <em>Action A</em> again. ü§Ø</p>

<blockquote>
  <p>How often does this happen in practice? ü§î A ton! Consider changes to comments that don‚Äôt effect the output. Bazel also considers the output hash on the target‚Äôs ABI, so in the case of C++ that might constitute the header files and in Java they strip out all private methods to create an ‚Äúinterface jar‚Äù (<a href="https://github.com/bazelbuild/bazel/blob/master/third_party/ijar/README.txt">ijar</a>).</p>
</blockquote>

<p>Watch out though, if you use <a href="https://bazel.build/reference/be/general#genrule">genrule</a> you can find yourself easily producing outputs that are not reproducible if nothing changes which will kill this pruning of the action graph.</p>

<p>Let‚Äôs look at an example.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">genrule</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"output_zip"</span><span class="p">,</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"output.zip"</span><span class="p">],</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s">"""
    echo 'Hello, World!' &gt; hello.txt &amp;&amp; </span><span class="se">\\</span><span class="s">
    zip output.zip hello.txt &amp;&amp; mv output.zip $@
    """</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">genrule</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"hello_text"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s">":output_jar"</span><span class="p">],</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"hello.txt"</span><span class="p">],</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s">"""
    unzip $(location :output_jar) hello.txt -d $(GENDIR) </span><span class="se">\\</span><span class="s">
    &amp;&amp; mv $(GENDIR)/hello.txt $@
    """</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>This is a very simple setup where I‚Äôm producing a ZIP file and in in the final target unzipping it.</p>

<p>ZIP files unfortunately are normally non-reproducible because they include modification timestamp information embedded in them &amp; the order the files are included are non-ordered.</p>

<p>Let‚Äôs build this with Bazel. We will use the <a href="https://github.com/bazelbuild/bazel/blob/master/src/tools/execlog/README.md">execlog</a> to view all the actions that were processed.</p>

<blockquote>
  <p>The <em>execlog</em> is an output file that is generated of all the actions Bazel undertook. 
We simply select the <em>targetLabel</em> to view the actions executed.</p>
</blockquote>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>bazel <span class="nt">--ignore_all_rc_files</span> build //:hello_text <span class="se">\</span>
<span class="go">    --execution_log_json_file=/tmp/exec.log.json

</span><span class="gp">&gt;</span><span class="w"> </span><span class="nb">cat</span> /tmp/exec.log.json | jq .targetLabel
<span class="go">"//:output_zip"
"//:hello_text"
</span></code></pre></div></div>

<p>Now let‚Äôs <strong>delete</strong> the <em>output.zip</em> file by doing <code class="language-plaintext highlighter-rouge">rm bazel-bin/output.zip</code> and
re-run Bazel.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>bazel <span class="nt">--ignore_all_rc_files</span> build //:hello_text <span class="se">\</span>
<span class="go">    --execution_log_json_file=/tmp/exec.log.json

</span><span class="gp">&gt;</span><span class="w"> </span><span class="nb">cat</span> /tmp/exec.log.json | jq .targetLabel
<span class="go">"//:output_zip"
"//:hello_text"
</span></code></pre></div></div>

<p>Both targets are still being run! üò¢</p>

<p>Fortunately, there are a few alternatives we can use such as <a href="https://github.com/bazelbuild/rules_pkg">rules_pkg</a> or <a href="https://github.com/bazelbuild/bazel/blob/master/tools/zip/BUILD">@bazel_tools//tools/zip:zipper</a> that has support for creating ZIP archive format in <em>a reproducible way</em>.</p>

<p>Let‚Äôs modify our code now to use <code class="language-plaintext highlighter-rouge">@bazel_tools//tools/zip:zipper</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">genrule</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"output_zip"</span><span class="p">,</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"output.zip"</span><span class="p">],</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s">"""
    echo 'Hello, World!' &gt; hello.txt &amp;&amp; </span><span class="se">\\</span><span class="s">
    $(location @bazel_tools//tools/zip:zipper) c $@ hello.txt
    """</span><span class="p">,</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="s">"@bazel_tools//tools/zip:zipper"</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">genrule</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"hello_text"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s">":output_zip"</span><span class="p">],</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"hello.txt"</span><span class="p">],</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s">"""
    unzip $(location :output_zip) hello.txt -d $(GENDIR) </span><span class="se">\\</span><span class="s">
    &amp;&amp; mv $(GENDIR)/hello.txt $@
    """</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>We‚Äôve effectively done the same thing as before, but we are being more mindful about
creating our output to be reproducible if the inputs are the same.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span><span class="nb">rm </span>bazel-bin/output.zip
<span class="go">override r-xr-xr-x fzakaria/wheel for bazel-bin/output.zip? y

</span><span class="gp">&gt;</span><span class="w"> </span>bazel <span class="nt">--ignore_all_rc_files</span> build //:hello_text <span class="se">\</span>
<span class="go">    --execution_log_json_file=/tmp/exec.log.json

</span><span class="gp">&gt;</span><span class="w"> </span><span class="nb">cat</span> /tmp/exec.log.json | jq .targetLabel
<span class="go">"//:output_zip"
</span></code></pre></div></div>

<p>üôå  YES! As expected we now only re-run the <em>output_zip</em> action and the final action
can be skipped.</p>

<p>We now have our graph reproducible in a way that can help Bazel give us incremental rebuilds by skipping portions of the graph. ü•≥</p>

<p>If reproducible builds interest you, I <em>highly</em> recommend you check out the wealth of information on the subject by the <a href="https://reproducible-builds.org/docs/">Reproducible Builds Group</a>. They‚Äôve documented all the various intricate ways they discovered software builds introduce nondeterminism into the build.</p>


<hr />
    </article>
</div>

<div class="sidebar">
    <hr class="visible-xs" />
    <img class="avatar" src="/assets/images/avatar-164.png" alt="A photo of my dog Moose" title="My dog Moose"/>
    <p>I'm a software engineer, father and wishful amateur surfer. If you've come seeking my political views; you've found the wrong <a href="https://fareedzakaria.com/">Fareed</a>.</p>
    <div class="external-links">
      <p>
        <span class="context">linkedin</span>
        <a href="https://www.linkedin.com/in/fmzakari/">fmzakari</a>
      </p>
      <p>
        <span class="context">github</span>
        <a href="https://github.com/fzakaria">fzakaria</a>
      </p>
      <p>
        <span class="context">email</span>
        <a href="mailto:farid.m.zakaria@gmail.com">farid.m.zakaria@gmail.com</a>
      </p>
      <p>
        <span class="context">pgp</span>
        <a href="/publickey.txt">D1B232E7</a>
      </p>
      <p>
        <a href="/archive">Archive</a>
      </p>
      <p>
        <a href="/old_blog/">Historic WordPress Blog</a>
      </p>
      <!--
      <p>
        Web friendly version of my <a href="/resume/index.html">resume</a>.
      </p>
    </div>
    <h3>Projects</h3>
    <p>
      <a href="/projects/">Click here</a> for some personal
      projects I've worked on.
    </p>
    <h3>Old Blog</h3>
    <p>
      <a href="/old_blog/">Click here</a> for the archive
      of my old blog posts from Wordpress.
    </p>
    -->
    
    <h3>Recent Posts</h3>
    
    <div class="post-stub">
      2025-02-02<br />
      <a href="/2025/02/02/nix-string-interpolation-of-directories-gone-awry.html">Nix: string interpolation of directories gone awry</a>
    </div>
    
    <div class="post-stub">
      2025-01-28<br />
      <a href="/2025/01/28/bazel-build-event-protocol-viewer.html">Bazel: Build Event Protocol Viewer</a>
    </div>
    
    <div class="post-stub">
      2025-01-12<br />
      <a href="/2025/01/12/bazel-knowledge-be-mindful-of-build-without-the-bytes.html">Bazel Knowledge: Be mindful of Build Without the Bytes (bwob)</a>
    </div>
    
    
    <h3>License</h3>
    <p style="font-size: 10pt">
    The content for this site is
    <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>.
    The <a href="https://github.com/SirCmpwn/ddjekyll">inspiration for the theme</a> for this site is
    ¬© Drew Devault.
    </p>
    <div class="spacer" style="margin-top: 30px;"></div>
    
    <p><a href="https://github.com/fzakaria/fzakaria.com/edit/master/_posts/2024-09-26-bazel-knowledge-reproducible-outputs.md">
      Improve this page @ 417ff2d
    </a></p>

</div>
        </div>
    </body>
</html>
