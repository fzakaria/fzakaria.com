<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Automatic Nix flake follows | Farid Zakaria‚Äôs Blog</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Automatic Nix flake follows" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="If you have used Nix flakes, you likely encountered something like the following. ü§¢ std.url = &quot;github:divnix/std&quot;; std.inputs.devshell.follows = &quot;devshell&quot;; std.inputs.nixago.follows = &quot;nixago&quot;; std.inputs.nixpkgs.follows = &quot;nixpkgs&quot;; hive.url = &quot;github:divnix/hive&quot;; hive.inputs.colmena.follows = &quot;colmena&quot;; hive.inputs.disko.follows = &quot;disko&quot;; hive.inputs.nixos-generators.follows = &quot;nixos-generators&quot;; hive.inputs.nixpkgs.follows = &quot;nixpkgs&quot;; Why is this follows necessary? ü§î It‚Äôs in fact not necessary but it makes the Nix evaluation simpler and as a result faster. ü§ì" />
<meta property="og:description" content="If you have used Nix flakes, you likely encountered something like the following. ü§¢ std.url = &quot;github:divnix/std&quot;; std.inputs.devshell.follows = &quot;devshell&quot;; std.inputs.nixago.follows = &quot;nixago&quot;; std.inputs.nixpkgs.follows = &quot;nixpkgs&quot;; hive.url = &quot;github:divnix/hive&quot;; hive.inputs.colmena.follows = &quot;colmena&quot;; hive.inputs.disko.follows = &quot;disko&quot;; hive.inputs.nixos-generators.follows = &quot;nixos-generators&quot;; hive.inputs.nixpkgs.follows = &quot;nixpkgs&quot;; Why is this follows necessary? ü§î It‚Äôs in fact not necessary but it makes the Nix evaluation simpler and as a result faster. ü§ì" />
<link rel="canonical" href="https://fzakaria.com/2024/07/31/automatic-nix-flake-follows.html" />
<meta property="og:url" content="https://fzakaria.com/2024/07/31/automatic-nix-flake-follows.html" />
<meta property="og:site_name" content="Farid Zakaria‚Äôs Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-07-31T22:21:00-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Automatic Nix flake follows" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-07-31T22:21:00-07:00","datePublished":"2024-07-31T22:21:00-07:00","description":"If you have used Nix flakes, you likely encountered something like the following. ü§¢ std.url = &quot;github:divnix/std&quot;; std.inputs.devshell.follows = &quot;devshell&quot;; std.inputs.nixago.follows = &quot;nixago&quot;; std.inputs.nixpkgs.follows = &quot;nixpkgs&quot;; hive.url = &quot;github:divnix/hive&quot;; hive.inputs.colmena.follows = &quot;colmena&quot;; hive.inputs.disko.follows = &quot;disko&quot;; hive.inputs.nixos-generators.follows = &quot;nixos-generators&quot;; hive.inputs.nixpkgs.follows = &quot;nixpkgs&quot;; Why is this follows necessary? ü§î It‚Äôs in fact not necessary but it makes the Nix evaluation simpler and as a result faster. ü§ì","headline":"Automatic Nix flake follows","mainEntityOfPage":{"@type":"WebPage","@id":"https://fzakaria.com/2024/07/31/automatic-nix-flake-follows.html"},"url":"https://fzakaria.com/2024/07/31/automatic-nix-flake-follows.html"}</script>
<!-- End Jekyll SEO tag -->

        <link type="application/atom+xml" rel="alternate" href="https://fzakaria.com/feed.xml" title="Farid Zakaria&apos;s Blog" />
        <link rel="stylesheet" type="text/css" href="/assets/css/base.css">
        <link rel="icon" type="image/x-icon" href="/assets/images/avatar.ico">
        <link rel="alternate" type="application/atom+xml" title="Farid Zakaria's Blog" href="/feed.xml">

        <link ref="">

        
        

        
            <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-35360900-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-35360900-1');
</script>

        

    </head>
    <body>
        

        <div class="container">
            <h1 class="page-title">
    <a class="rss pull-right" href="/feed.xml"><i class="fa fa-rss"></i></a>
    Automatic Nix flake follows
</h1>

<div class="content">
    
    <p class="date">
        Published 2024-07-31
        on <a href="/">Farid Zakaria's Blog</a>
        <span class="hidden-xs">
          &mdash;
          <a href="/2024/07/31/automatic-nix-flake-follows.html">
            Permalink
          </a>
        </span>
    </p>
    
    <article>
      <p>If you have used <a href="https://nixos.org">Nix</a> flakes, you likely encountered something like the following. ü§¢</p>

<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">std</span><span class="o">.</span><span class="nv">url</span> <span class="o">=</span> <span class="s2">"github:divnix/std"</span><span class="p">;</span>
<span class="nv">std</span><span class="o">.</span><span class="nv">inputs</span><span class="o">.</span><span class="nv">devshell</span><span class="o">.</span><span class="nv">follows</span> <span class="o">=</span> <span class="s2">"devshell"</span><span class="p">;</span>
<span class="nv">std</span><span class="o">.</span><span class="nv">inputs</span><span class="o">.</span><span class="nv">nixago</span><span class="o">.</span><span class="nv">follows</span> <span class="o">=</span> <span class="s2">"nixago"</span><span class="p">;</span>
<span class="nv">std</span><span class="o">.</span><span class="nv">inputs</span><span class="o">.</span><span class="nv">nixpkgs</span><span class="o">.</span><span class="nv">follows</span> <span class="o">=</span> <span class="s2">"nixpkgs"</span><span class="p">;</span>

<span class="nv">hive</span><span class="o">.</span><span class="nv">url</span> <span class="o">=</span> <span class="s2">"github:divnix/hive"</span><span class="p">;</span>
<span class="nv">hive</span><span class="o">.</span><span class="nv">inputs</span><span class="o">.</span><span class="nv">colmena</span><span class="o">.</span><span class="nv">follows</span> <span class="o">=</span> <span class="s2">"colmena"</span><span class="p">;</span>
<span class="nv">hive</span><span class="o">.</span><span class="nv">inputs</span><span class="o">.</span><span class="nv">disko</span><span class="o">.</span><span class="nv">follows</span> <span class="o">=</span> <span class="s2">"disko"</span><span class="p">;</span>
<span class="nv">hive</span><span class="o">.</span><span class="nv">inputs</span><span class="o">.</span><span class="nv">nixos-generators</span><span class="o">.</span><span class="nv">follows</span> <span class="o">=</span> <span class="s2">"nixos-generators"</span><span class="p">;</span>
<span class="nv">hive</span><span class="o">.</span><span class="nv">inputs</span><span class="o">.</span><span class="nv">nixpkgs</span><span class="o">.</span><span class="nv">follows</span> <span class="o">=</span> <span class="s2">"nixpkgs"</span><span class="p">;</span>
</code></pre></div></div>

<p>Why is this follows necessary? ü§î</p>

<p>It‚Äôs in fact <strong>not necessary</strong> but it makes the Nix evaluation simpler and as a result faster. ü§ì</p>

<!--more-->

<p>Rather than using the exact Nix flake commit your dependency desires, we are overriding it, with one we have likely already declared. This has the effect of making our graph smaller, which is faster to evaluate and likely build.</p>

<p>For very large Nix projects, the Nix evaluator can be surprisingly slow, so the pattern of <em>follows</em>, especially for <em>nixpkgs</em>, is incredibly common.</p>

<blockquote>
  <p>Note: Although it‚Äôs faster it‚Äôs <em>less correct</em> since we are deviating from what the authors of the flake desired.</p>
</blockquote>

<p>Writing all those follows can get real teadious ü•±, and it‚Äôs tough to even know you did them all.</p>

<p>Surely there has to be a better way? üôè</p>

<p>Well take a look at <a href="https://github.com/fzakaria/nix-auto-follow">nix-auto-follow</a> ü•≥</p>

<p>Simply run the script which will modify your <em>flake.lock</em> file. Commit the change and voil√†!</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>python all-follow.py flake.lock <span class="nt">-i</span>
</code></pre></div></div>

<p>How does it work? üßê Let‚Äôs dive in with an example.</p>

<p>Here let‚Äôs create our main top-level flake. You can think of this as your application or NixOS machine.</p>

<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="nv">description</span> <span class="o">=</span> <span class="s2">"Top Level Flake"</span><span class="p">;</span>

  <span class="nv">inputs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">a</span><span class="o">.</span><span class="nv">url</span> <span class="o">=</span> <span class="nv">path</span><span class="p">:</span><span class="sx">./a</span><span class="p">;</span>
    <span class="nv">nixpkgs</span><span class="o">.</span><span class="nv">url</span> <span class="o">=</span> <span class="s2">"github:nixos/nixpkgs/nixos-24.05"</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nv">outputs</span> <span class="o">=</span> <span class="p">{</span> <span class="nv">self</span><span class="p">,</span> <span class="nv">a</span><span class="p">,</span> <span class="nv">nixpkgs</span> <span class="p">}:</span> 
  <span class="p">{</span>
    <span class="nv">versions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nv">a</span><span class="o">.</span><span class="nv">nixpkgs</span> <span class="o">=</span> <span class="nv">a</span><span class="o">.</span><span class="nv">versions</span><span class="o">.</span><span class="nv">nixpkgs</span><span class="p">;</span>
        <span class="nv">nixpkgs</span> <span class="o">=</span> <span class="nv">nixpkgs</span><span class="o">.</span><span class="nv">lib</span><span class="o">.</span><span class="nv">version</span><span class="p">;</span>
    <span class="p">};</span>
    
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Our flake has <strong>2</strong> dependencies: <code class="language-plaintext highlighter-rouge">a</code> &amp; <code class="language-plaintext highlighter-rouge">nixpkgs</code>.</p>

<p>To keep this example simple, <code class="language-plaintext highlighter-rouge">a</code> is another local flake which itself only has <strong>1</strong> dependency: <code class="language-plaintext highlighter-rouge">nixpkgs</code>.</p>

<p>‚ùó Important to notice here that <code class="language-plaintext highlighter-rouge">nixpkgs</code> is at a different version in <code class="language-plaintext highlighter-rouge">a</code>. We have two versions <strong>23.11</strong> &amp; <strong>24.05</strong>.</p>

<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="nv">description</span> <span class="o">=</span> <span class="s2">"Flake A"</span><span class="p">;</span>

  <span class="nv">inputs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">nixpkgs</span><span class="o">.</span><span class="nv">url</span> <span class="o">=</span> <span class="s2">"github:nixos/nixpkgs/nixos-23.11"</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nv">outputs</span> <span class="o">=</span> <span class="p">{</span> <span class="nv">self</span><span class="p">,</span> <span class="nv">nixpkgs</span> <span class="p">}:</span> 
  <span class="p">{</span>
    <span class="nv">versions</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nv">nixpkgs</span> <span class="o">=</span> <span class="nv">nixpkgs</span><span class="o">.</span><span class="nv">lib</span><span class="o">.</span><span class="nv">version</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Our flake emits a <code class="language-plaintext highlighter-rouge">versions</code> attribute which we can evaluate.
We correcltly see at the start the two different versions of <em>nixpkgs</em>.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">‚ùØ nix eval "#</span>versions<span class="s2">"
</span><span class="go">
{
</span><span class="gp">  a = {nixpkgs = "23.11pre-git";</span><span class="o">}</span><span class="p">;</span>
<span class="gp">  nixpkgs = "24.05.20240729.12bf098";</span><span class="w">
</span><span class="go">}
</span></code></pre></div></div>

<p>If we peek in our <code class="language-plaintext highlighter-rouge">flake.lock</code> file we see that <code class="language-plaintext highlighter-rouge">nixpkgs</code> is listed twice as an <em>inputs</em> (<code class="language-plaintext highlighter-rouge">nixpkgs</code> &amp; <code class="language-plaintext highlighter-rouge">nixpkgs_2</code>) and that they reference nodes that exist.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"nodes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"a"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"inputs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"nixpkgs"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nixpkgs"</span><span class="w">
      </span><span class="p">},</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"root"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"inputs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"a"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"nixpkgs"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nixpkgs_2"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"nixpkgs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"nixpkgs_2"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="p">},</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Turns out if we make the nodes references by the <code class="language-plaintext highlighter-rouge">inputs</code> in <code class="language-plaintext highlighter-rouge">roots</code> (our top level <em>flake.nix</em>) the same everywhere, we‚Äôve effectively done an <strong>automatic follows</strong>.</p>

<p>Let‚Äôs apply <em>all-follow.py</em> and see what happens.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">‚ùØ python all-follow.py flake.lock -i

</span><span class="gp">‚ùØ nix eval "#</span>versions<span class="s2">"
</span><span class="go">{
</span><span class="gp">  a = {nixpkgs = "24.05.20240729.12bf098";</span><span class="o">}</span><span class="p">;</span>
<span class="gp">  nixpkgs = "24.05.20240729.12bf098";</span><span class="w">
</span><span class="go">}
</span></code></pre></div></div>

<p>The <em>nixpkgs</em> versions are now the same! üéÜ</p>

<p>Although this <em>post-processing</em> happens out of band from the Nix tool, it‚Äôs an incredibly simple way to simplify your Nix evaluation and build graph and save you from <strong>follows hell</strong> (Nix‚Äôs version of <em>DLL Hell</em>)</p>

<p>If you find the tool useful, please consider contributing. You can find it at <a href="https://github.com/fzakaria/nix-auto-follow">https://github.com/fzakaria/nix-auto-follow</a>.</p>

<blockquote>
  <p>Special thanks to <a href="https://github.com/edolstra">edolstra</a> &amp; <a href="https://github.com/roberth">roberth</a> who helped me think through this. üôá‚Äç‚ôÇÔ∏è</p>
</blockquote>


<hr />
    </article>
</div>

<div class="sidebar">
    <hr class="visible-xs" />
    <img class="avatar" src="/assets/images/avatar-164.png" alt="A photo of my dog Moose" title="My dog Moose"/>
    <p>I'm a software engineer, father and wishful amateur surfer. If you've come seeking my political views; you've found the wrong <a href="https://fareedzakaria.com/">Fareed</a>.</p>
    <div class="external-links">
      <p>
        <span class="context">linkedin</span>
        <a href="https://www.linkedin.com/in/fmzakari/">fmzakari</a>
      </p>
      <p>
        <span class="context">github</span>
        <a href="https://github.com/fzakaria">fzakaria</a>
      </p>
      <p>
        <span class="context">email</span>
        <a href="mailto:farid.m.zakaria@gmail.com">farid.m.zakaria@gmail.com</a>
      </p>
      <p>
        <span class="context">pgp</span>
        <a href="/publickey.txt">D1B232E7</a>
      </p>
      <p>
        <a href="/archive">Archive</a>
      </p>
      <p>
        <a href="/old_blog/">Historic WordPress Blog</a>
      </p>
      <!--
      <p>
        Web friendly version of my <a href="/resume/index.html">resume</a>.
      </p>
    </div>
    <h3>Projects</h3>
    <p>
      <a href="/projects/">Click here</a> for some personal
      projects I've worked on.
    </p>
    <h3>Old Blog</h3>
    <p>
      <a href="/old_blog/">Click here</a> for the archive
      of my old blog posts from Wordpress.
    </p>
    -->
    
    <h3>Recent Posts</h3>
    
    <div class="post-stub">
      2025-02-02<br />
      <a href="/2025/02/02/nix-string-interpolation-of-directories-gone-awry.html">Nix: string interpolation of directories gone awry</a>
    </div>
    
    <div class="post-stub">
      2025-01-28<br />
      <a href="/2025/01/28/bazel-build-event-protocol-viewer.html">Bazel: Build Event Protocol Viewer</a>
    </div>
    
    <div class="post-stub">
      2025-01-12<br />
      <a href="/2025/01/12/bazel-knowledge-be-mindful-of-build-without-the-bytes.html">Bazel Knowledge: Be mindful of Build Without the Bytes (bwob)</a>
    </div>
    
    
    <h3>License</h3>
    <p style="font-size: 10pt">
    The content for this site is
    <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>.
    The <a href="https://github.com/SirCmpwn/ddjekyll">inspiration for the theme</a> for this site is
    ¬© Drew Devault.
    </p>
    <div class="spacer" style="margin-top: 30px;"></div>
    
    <p><a href="https://github.com/fzakaria/fzakaria.com/edit/master/_posts/2024-07-31-automatic-nix-flake-follows.md">
      Improve this page @ 417ff2d
    </a></p>

</div>
        </div>
    </body>
</html>
