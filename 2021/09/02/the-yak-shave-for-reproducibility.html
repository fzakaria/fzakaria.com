<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>The yak shave for reproducibility | Farid Zakaria‚Äôs Blog</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="The yak shave for reproducibility" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I have been on a mission to bring reproducibility through the use of Nix into my workplace as we envision the next version of our development environment. Similar to the movies I watch that take place in space, it only takes a small hole to destroy your hermetic environment. üßë‚ÄçüöÄ" />
<meta property="og:description" content="I have been on a mission to bring reproducibility through the use of Nix into my workplace as we envision the next version of our development environment. Similar to the movies I watch that take place in space, it only takes a small hole to destroy your hermetic environment. üßë‚ÄçüöÄ" />
<link rel="canonical" href="https://fzakaria.com/2021/09/02/the-yak-shave-for-reproducibility.html" />
<meta property="og:url" content="https://fzakaria.com/2021/09/02/the-yak-shave-for-reproducibility.html" />
<meta property="og:site_name" content="Farid Zakaria‚Äôs Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-09-02T18:01:00-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="The yak shave for reproducibility" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-09-02T18:01:00-07:00","datePublished":"2021-09-02T18:01:00-07:00","description":"I have been on a mission to bring reproducibility through the use of Nix into my workplace as we envision the next version of our development environment. Similar to the movies I watch that take place in space, it only takes a small hole to destroy your hermetic environment. üßë‚ÄçüöÄ","headline":"The yak shave for reproducibility","mainEntityOfPage":{"@type":"WebPage","@id":"https://fzakaria.com/2021/09/02/the-yak-shave-for-reproducibility.html"},"url":"https://fzakaria.com/2021/09/02/the-yak-shave-for-reproducibility.html"}</script>
<!-- End Jekyll SEO tag -->

        <link type="application/atom+xml" rel="alternate" href="https://fzakaria.com/feed.xml" title="Farid Zakaria&apos;s Blog" />
        <link rel="stylesheet" type="text/css" href="/assets/css/base.css">
        <link rel="icon" type="image/x-icon" href="/assets/images/avatar.ico">
        <link rel="alternate" type="application/atom+xml" title="Farid Zakaria's Blog" href="/feed.xml">

        <link ref="">

        
        

        
            <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-35360900-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-35360900-1');
</script>

        

    </head>
    <body>
        

        <div class="container">
            <h1 class="page-title">
    <a class="rss pull-right" href="/feed.xml"><i class="fa fa-rss"></i></a>
    The yak shave for reproducibility
</h1>

<div class="content">
    
    <p class="date">
        Published 2021-09-02
        on <a href="/">Farid Zakaria's Blog</a>
        <span class="hidden-xs">
          &mdash;
          <a href="/2021/09/02/the-yak-shave-for-reproducibility.html">
            Permalink
          </a>
        </span>
    </p>
    
    <article>
      <p>I have been on a mission to bring reproducibility through the use of <a href="http://nixos.org/">Nix</a> into my workplace as we envision the next version of our development environment.</p>

<p>Similar to the movies I watch that take place in space, it only takes a small hole to destroy your hermetic environment. üßë‚ÄçüöÄ</p>

<!--more-->

<p>I‚Äôve <a href="/2020/11/12/debugging-a-jnr-ffi-bug-in-nix.html">written previously</a> about my encounters trying to remove all impurities within a JVM environment.</p>

<p>I‚Äôve actually <a href="https://github.com/NixOS/nixpkgs/pull/123708">upstreamed</a> fixing the default <em>java.library.path</em> for the OpenJDK distributed by Nixpkgs. üôå</p>

<p>Awesome! That should have solved my problem, right ?‚Ä¶</p>

<p>Unfortunately, <em>impurities</em> are tough to stamp out. NixOS is trying to accomplish a paradigm shift by dismissing the <em><a href="https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard">filesystem hierarchy standard</a></em> but it is deeply rooted in assumptions when people build for Linux.</p>

<p>In my specific case, the search paths for the JNR libraries were <a href="https://github.com/jnr/jnr-ffi/blob/2161d3d875869bdaf292b0e9267bb0fbdb0f3f2b/src/main/java/jnr/ffi/LibraryLoader.java#L511">hardcoded</a>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// paths should have no duplicate entries and have insertion order</span>
<span class="nc">LinkedHashSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">paths</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;();</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">paths</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">getPropertyPaths</span><span class="o">(</span><span class="s">"jnr.ffi.library.path"</span><span class="o">));</span>
    <span class="n">paths</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">getPropertyPaths</span><span class="o">(</span><span class="s">"jaffl.library.path"</span><span class="o">));</span>
    <span class="c1">// Add JNA paths for compatibility</span>
    <span class="n">paths</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">getPropertyPaths</span><span class="o">(</span><span class="s">"jna.library.path"</span><span class="o">));</span>
    <span class="c1">// java.library.path should take care of Windows defaults</span>
    <span class="n">paths</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">getPropertyPaths</span><span class="o">(</span><span class="s">"java.library.path"</span><span class="o">));</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="nc">Platform</span><span class="o">.</span><span class="na">getNativePlatform</span><span class="o">().</span><span class="na">isUnix</span><span class="o">())</span> <span class="o">{</span>
    <span class="c1">// order is intentional!</span>
    <span class="n">paths</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"/usr/local/lib"</span><span class="o">);</span>
    <span class="n">paths</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"/usr/lib"</span><span class="o">);</span>
    <span class="n">paths</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"/lib"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>I‚Äôve sent <a href="https://github.com/jnr/jnr-ffi/pull/264/">a fix upstream</a> please feel free to comment.</p>
</blockquote>

<p>This meant that I had to make sure the <em>java.library.path</em> resolved to the <em>glibc</em> I am using in Nixpkgs first.</p>

<p>I couldn‚Äôt get rid of the <code class="language-plaintext highlighter-rouge">JAVA_TOOL_OPTIONS</code> just yet. üò§</p>

<h2 id="whats-the-cost-of-all-this">What‚Äôs the cost of all this?</h2>

<p>First off, the JDK emits <code class="language-plaintext highlighter-rouge">JAVA_TOOL_OPTIONS</code> via <em>stderr</em> which is <a href="https://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/9a751dc19fae78ce58fb0eb176522070c992fb6f/hotspot/src/share/vm/runtime/arguments.cpp#L3753">non-configurable</a>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">::</span><span class="n">getenv</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
    <span class="o">!</span><span class="n">os</span><span class="o">::</span><span class="n">have_special_privileges</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">JavaVMOption</span> <span class="n">options</span><span class="p">[</span><span class="n">N_MAX_OPTIONS</span><span class="p">];</span>      <span class="c1">// Construct option array</span>
  <span class="n">jio_fprintf</span><span class="p">(</span><span class="n">defaultStream</span><span class="o">::</span><span class="n">error_stream</span><span class="p">(),</span>
            <span class="s">"Picked up %s: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
</code></pre></div></div>

<p>This is frustrating because plenty of tools (i.e. IntelliJ) assume failure if anything is emitted to <em>stderr</em>.</p>

<p>Secondly, we have many developers that are being hit by this particular workflow:</p>

<ol>
  <li>Developer sets up their IntelliJ JRuby SDK to point to Jruby which points to <em>/nix/store</em> path <strong>A</strong> linked with glibc <strong>B</strong>.</li>
  <li>Developer changes their Git branch to a different point in time where JRuby points to a different <em>/nix/store</em> path <strong>X</strong> linked with glibc <strong>Z</strong>.</li>
  <li>The developer restarts IntelliJ and picks up the new environment variable <em>JAVA_TOOL_OPTIONS</em> üí•</li>
</ol>

<blockquote>
  <p>If you read <a href="/2020/11/12/debugging-a-jnr-ffi-bug-in-nix.html">my earlier post</a>, you‚Äôll understand why <em>JAVA_TOOL_OPTIONS</em> includes glibc.</p>
</blockquote>

<p>That <em>JAVA_TOOL_OPTIONS</em> references glibc <strong>Z</strong> but their JRuby SDK is pointing to JRuby <strong>A</strong> which was built against glibc <strong>B</strong>.</p>

<p>They are then graced with this <em>wonderful</em> message.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java.lang.UnsatisfiedLinkError: /nix/store/cvr0kjg2q7z2wwhjblx6c73rv422k8cm-glibc-2.33-47/lib/libc.so.6: undefined symbol: _dl_catch_error_ptr, version GLIBC_PRIVATE
	at jnr.ffi.provider.jffi.NativeLibrary.loadNativeLibraries(NativeLibrary.java:93)
</code></pre></div></div>

<p>Ugh! The fix here is straightforward ultimately ‚Äì the developer needs to be mindful of their JRuby SDK set in IntelliJ and keep it in sync with their local checkout.</p>

<p>Unfortunately it‚Äôs a sharp edge many are running into; and I don‚Äôt blame them!</p>

<p>We will be thinking of some sane ways to keep these two tools in sync so that we can remain on upstream for now‚Ä¶ ü§î</p>


<hr />
    </article>
</div>

<div class="sidebar">
    <hr class="visible-xs" />
    <img class="avatar" src="/assets/images/avatar-164.png" alt="A photo of my dog Moose" title="My dog Moose"/>
    <p>I'm a software engineer, father and wishful amateur surfer. If you've come seeking my political views; you've found the wrong <a href="https://fareedzakaria.com/">Fareed</a>.</p>
    <div class="external-links">
      <p>
        <span class="context">linkedin</span>
        <a href="https://www.linkedin.com/in/fmzakari/">fmzakari</a>
      </p>
      <p>
        <span class="context">github</span>
        <a href="https://github.com/fzakaria">fzakaria</a>
      </p>
      <p>
        <span class="context">email</span>
        <a href="mailto:farid.m.zakaria@gmail.com">farid.m.zakaria@gmail.com</a>
      </p>
      <p>
        <span class="context">pgp</span>
        <a href="/publickey.txt">D1B232E7</a>
      </p>
      <p>
        <a href="/archive">Archive</a>
      </p>
      <p>
        <a href="/old_blog/">Historic WordPress Blog</a>
      </p>
      <!--
      <p>
        Web friendly version of my <a href="/resume/index.html">resume</a>.
      </p>
    </div>
    <h3>Projects</h3>
    <p>
      <a href="/projects/">Click here</a> for some personal
      projects I've worked on.
    </p>
    <h3>Old Blog</h3>
    <p>
      <a href="/old_blog/">Click here</a> for the archive
      of my old blog posts from Wordpress.
    </p>
    -->
    
    <h3>Recent Posts</h3>
    
    <div class="post-stub">
      2025-02-02<br />
      <a href="/2025/02/02/nix-string-interpolation-of-directories-gone-awry.html">Nix: string interpolation of directories gone awry</a>
    </div>
    
    <div class="post-stub">
      2025-01-28<br />
      <a href="/2025/01/28/bazel-build-event-protocol-viewer.html">Bazel: Build Event Protocol Viewer</a>
    </div>
    
    <div class="post-stub">
      2025-01-12<br />
      <a href="/2025/01/12/bazel-knowledge-be-mindful-of-build-without-the-bytes.html">Bazel Knowledge: Be mindful of Build Without the Bytes (bwob)</a>
    </div>
    
    
    <h3>License</h3>
    <p style="font-size: 10pt">
    The content for this site is
    <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>.
    The <a href="https://github.com/SirCmpwn/ddjekyll">inspiration for the theme</a> for this site is
    ¬© Drew Devault.
    </p>
    <div class="spacer" style="margin-top: 30px;"></div>
    
    <p><a href="https://github.com/fzakaria/fzakaria.com/edit/master/_posts/2021-09-02-the-yak-shave-for-reproducibility.md">
      Improve this page @ 417ff2d
    </a></p>

</div>
        </div>
    </body>
</html>
