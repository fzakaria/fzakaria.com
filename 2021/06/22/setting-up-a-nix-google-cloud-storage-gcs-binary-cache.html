<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>setting up a Nix Google Cloud Storage (GCS) binary cache | Farid Zakaria‚Äôs Blog</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="setting up a Nix Google Cloud Storage (GCS) binary cache" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A previous post documented how to setup a binary cache directly on S3. Many however are tied to a different public IaaS offering and may not be able to leverage the native S3 integration Nix offers. Luckily for those using GCP, Google‚Äôs blob storage equivalent Google Cloud Storage (GCS) has interoperability with the S3 API. This will allow us to host our binary cache on GCS while still using the native S3 integration in Nix. Following this guide will allow Nix to leverage GCS without having to use a proxy such as nix-store-gcs-proxy." />
<meta property="og:description" content="A previous post documented how to setup a binary cache directly on S3. Many however are tied to a different public IaaS offering and may not be able to leverage the native S3 integration Nix offers. Luckily for those using GCP, Google‚Äôs blob storage equivalent Google Cloud Storage (GCS) has interoperability with the S3 API. This will allow us to host our binary cache on GCS while still using the native S3 integration in Nix. Following this guide will allow Nix to leverage GCS without having to use a proxy such as nix-store-gcs-proxy." />
<link rel="canonical" href="https://fzakaria.com/2021/06/22/setting-up-a-nix-google-cloud-storage-gcs-binary-cache.html" />
<meta property="og:url" content="https://fzakaria.com/2021/06/22/setting-up-a-nix-google-cloud-storage-gcs-binary-cache.html" />
<meta property="og:site_name" content="Farid Zakaria‚Äôs Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-06-22T08:26:00-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="setting up a Nix Google Cloud Storage (GCS) binary cache" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-06-22T08:26:00-07:00","datePublished":"2021-06-22T08:26:00-07:00","description":"A previous post documented how to setup a binary cache directly on S3. Many however are tied to a different public IaaS offering and may not be able to leverage the native S3 integration Nix offers. Luckily for those using GCP, Google‚Äôs blob storage equivalent Google Cloud Storage (GCS) has interoperability with the S3 API. This will allow us to host our binary cache on GCS while still using the native S3 integration in Nix. Following this guide will allow Nix to leverage GCS without having to use a proxy such as nix-store-gcs-proxy.","headline":"setting up a Nix Google Cloud Storage (GCS) binary cache","mainEntityOfPage":{"@type":"WebPage","@id":"https://fzakaria.com/2021/06/22/setting-up-a-nix-google-cloud-storage-gcs-binary-cache.html"},"url":"https://fzakaria.com/2021/06/22/setting-up-a-nix-google-cloud-storage-gcs-binary-cache.html"}</script>
<!-- End Jekyll SEO tag -->

        <link type="application/atom+xml" rel="alternate" href="https://fzakaria.com/feed.xml" title="Farid Zakaria&apos;s Blog" />
        <link rel="stylesheet" type="text/css" href="/assets/css/base.css">
        <link rel="icon" type="image/x-icon" href="/assets/images/avatar.ico">
        <link rel="alternate" type="application/atom+xml" title="Farid Zakaria's Blog" href="/feed.xml">

        <link ref="">

        
        

        
            <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-35360900-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-35360900-1');
</script>

        

    </head>
    <body>
        

        <div class="container">
            <h1 class="page-title">
    <a class="rss pull-right" href="/feed.xml"><i class="fa fa-rss"></i></a>
    setting up a Nix Google Cloud Storage (GCS) binary cache
</h1>

<div class="content">
    
    <p class="date">
        Published 2021-06-22
        on <a href="/">Farid Zakaria's Blog</a>
        <span class="hidden-xs">
          &mdash;
          <a href="/2021/06/22/setting-up-a-nix-google-cloud-storage-gcs-binary-cache.html">
            Permalink
          </a>
        </span>
    </p>
    
    <article>
      <p>A previous post documented how to <a href="/2020/07/15/setting-up-a-nix-s3-binary-cache.html">setup a binary cache directly on S3</a>.
Many however are tied to a different public IaaS offering and may not be able to leverage the native S3 integration Nix offers.
Luckily for those using GCP, Google‚Äôs blob storage equivalent <a href="https://cloud.google.com/storage">Google Cloud Storage (GCS)</a> has <a href="https://cloud.google.com/storage/docs/interoperability">interoperability</a> with the S3 API.</p>

<p>This will allow us to host our binary cache on GCS while still using the native S3 integration in Nix.
Following this guide will allow Nix to leverage GCS without having to use a proxy such as <a href="https://github.com/tweag/nix-store-gcs-proxy">nix-store-gcs-proxy</a>.</p>

<!--more-->

<blockquote>
  <p>The following guide will assume <em>some familiarity</em> with the GCP ecosystem.
You may want to follow best practices for reducing IAM roles and service account management.</p>
</blockquote>

<ol>
  <li>Let‚Äôs create a bucket for us to store the Nix binary artifacts.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ‚ùØ gsutil mb gs://nix-cache-testing
 Creating gs://nix-cache-testing/...
 <span class="c"># Validate it exists</span>
 ‚ùØ gsutil <span class="nb">du</span> <span class="nt">-s</span> gs://nix-cache-testing
 0            gs://nix-cache-testing
</code></pre></div>    </div>
  </li>
  <li>Create a <em>service account</em>.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ‚ùØ gcloud iam service-accounts create nix-cache-testing <span class="se">\</span>
 <span class="o">&gt;</span>       <span class="nt">--description</span><span class="o">=</span><span class="s2">"Service account for Nix GCS cache"</span> <span class="se">\</span>
 <span class="o">&gt;</span>       <span class="nt">--display-name</span><span class="o">=</span><span class="s2">"Nix GCS Service Account"</span>
 Created service account <span class="o">[</span>nix-cache-testing].
 <span class="c"># Validate it exists</span>
 ‚ùØ gcloud iam service-accounts list
 DISPLAY NAME                            EMAIL                                                                     DISABLED
 Nix GCS Service Account                 nix-cache-testing@my-project.google.com.iam.gserviceaccount.com  False
</code></pre></div>    </div>
  </li>
  <li>Create an <em>hmac</em> for use with S3 API.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ‚ùØ gsutil hmac create  nix-cache-testing@my-project.iam.gserviceaccount.com
 Access ID:   GOOGTS7C7FUP3AIRVJTE2BCDKINBTES3HC2GY5CBFJDCQ2SYHV6A6XXVTJFSA
 Secret:      &lt;SCRUBBED OUT FOR SECURITY&gt;
</code></pre></div>    </div>
  </li>
  <li>Attach an appropriate IAM role to the service account.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ‚ùØ gcloud projects add-iam-policy-binding my-project <span class="se">\</span>
     <span class="nt">--member</span><span class="o">=</span><span class="s2">"serviceAccount:nix-cache-testing@my-project.iam.gserviceaccount.com"</span> <span class="se">\</span>
     <span class="nt">--role</span><span class="o">=</span><span class="s2">"roles/storage.admin"</span> <span class="nt">--condition</span><span class="o">=</span>None
</code></pre></div>    </div>
  </li>
  <li>Set the credentials anywhere the <a href="https://docs.aws.amazon.com/cli/latest/topic/config-vars.html#credentials">that works</a> for the AWS CLI.
I‚Äôve chosen to do it in the <code class="language-plaintext highlighter-rouge">~/.aws/credentials</code> within a profile named <em>gcp</em>.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ‚ùØ <span class="nb">cat</span> ~/.aws/credentials
 <span class="o">[</span>gcp]
 aws_access_key_id <span class="o">=</span> GOOGTS7C7FUP3AIRVJTE2BCDKINBTES3HC2GY5CBFJDCQ2SYHV6A6XXVTJFSA
 aws_secret_access_key <span class="o">=</span> &lt;SCRUBBED OUT FOR SECURITY&gt;
</code></pre></div>    </div>
  </li>
  <li>
    <p>Try the <em>aws</em> CLI and validate everything works.</p>

    <blockquote>
      <p>You can avoid setting the endpoint-url if you use the <a href="https://github.com/wbingli/awscli-plugin-endpoint">awscli-plugin-endpoint</a>.</p>
    </blockquote>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ‚ùØ aws s3 <span class="nb">ls</span> <span class="nt">--profile</span> gcp <span class="nt">--endpoint-url</span> https://storage.googleapis.com
 2021-06-22 09:04:24 nix-cache-testing
</code></pre></div>    </div>
  </li>
</ol>

<p>üôå Woohoo! We‚Äôve just setup basic interoperability for GCS behaving like the S3 API.
Let‚Äôs see if the interopt is good enough to fool the API Nix relies on.</p>

<p>Let‚Äôs create a really basic derivation (<em>lolhello.nix</em>) we will be using to test.</p>

<blockquote>
  <p>For brevity, I‚Äôm not pinning my <em>nixpkgs</em> channel, but that practice is recommended.</p>
</blockquote>

<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span> <span class="nv">pkgs</span> <span class="o">?</span> <span class="kr">import</span> <span class="o">&lt;</span><span class="nv">nixpkgs</span><span class="o">&gt;</span> <span class="p">{</span> <span class="p">},</span> <span class="nv">stdenv</span> <span class="o">?</span> <span class="nv">pkgs</span><span class="o">.</span><span class="nv">stdenv</span><span class="p">,</span> <span class="nv">fetchurl</span> <span class="o">?</span> <span class="nv">pkgs</span><span class="o">.</span><span class="nv">fetchurl</span> <span class="p">}:</span>
<span class="nv">stdenv</span><span class="o">.</span><span class="nv">mkDerivation</span> <span class="p">{</span>
  <span class="nv">name</span> <span class="o">=</span> <span class="s2">"lolhello"</span><span class="p">;</span>

  <span class="nv">src</span> <span class="o">=</span> <span class="nv">fetchurl</span> <span class="p">{</span>
    <span class="nv">url</span> <span class="o">=</span> <span class="s2">"mirror://gnu/hello/hello-2.3.tar.bz2"</span><span class="p">;</span>
    <span class="nv">sha256</span> <span class="o">=</span> <span class="s2">"0c7vijq8y68bpr7g6dh1gny0bff8qq81vnp4ch8pjzvg56wb3js1"</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nv">patchPhase</span> <span class="o">=</span> <span class="s2">''</span><span class="err">
</span><span class="s2">    sed -i 's/Hello, world!/hello, Nix!/g' src/hello.c</span><span class="err">
</span><span class="s2">  ''</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Let‚Äôs build it. üèóÔ∏è</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚ùØ nix-build lolhello.nix <span class="nt">--no-out-link</span>
/nix/store/czf8l5nlp2kaag96hb42qvqd85glr8f8-lolhello
</code></pre></div></div>

<p>Now let‚Äôs try to upload it to our GCS bucket via the S3 integration in Nix.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚ùØ nix copy <span class="si">$(</span>nix-build lolhello.nix <span class="nt">--no-out-link</span><span class="si">)</span> <span class="se">\</span>
    <span class="nt">--to</span> <span class="s2">"s3://nix-cache-testing?endpoint=https://storage.googleapis.com&amp;profile=gcp"</span>

<span class="c"># Check it's been uploaded</span>
‚ùØ aws s3 <span class="nb">ls </span>nix-cache-testing <span class="nt">--profile</span><span class="o">=</span>gcp <span class="nt">--endpoint-url</span> https://storage.googleapis.com
                           PRE nar/
2021-06-22 12:09:42        476 czf8l5nlp2kaag96hb42qvqd85glr8f8.narinfo

<span class="c"># Check it using the gsutil also</span>
‚ùØ gsutil <span class="nb">ls </span>gs://nix-cache-testing
gs://nix-cache-testing/czf8l5nlp2kaag96hb42qvqd85glr8f8.narinfo
gs://nix-cache-testing/nar/
</code></pre></div></div>

<p>Now let‚Äôs delete it from our system.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚ùØ nix-store <span class="nt">--delete</span> /nix/store/czf8l5nlp2kaag96hb42qvqd85glr8f8-lolhello
</code></pre></div></div>

<p>Now let‚Äôs try to build it, using our substituter.
We will also disable building locally to verify everything is working correctly.</p>

<blockquote>
  <p>I disabled verifying the signatures for now for simplicity of the demo. Please see my
<a href="/2020/07/15/setting-up-a-nix-s3-binary-cache.html">previous post</a> on how to add signatures.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚ùØ nix-build lolhello.nix <span class="nt">--no-out-link</span> <span class="nt">--builders</span> <span class="s1">''</span> <span class="nt">-j0</span> <span class="se">\</span>
    <span class="nt">--option</span> substituters <span class="s2">"s3://nix-cache-testing?endpoint=https://storage.googleapis.com&amp;profile=gcp"</span> <span class="se">\</span>
    <span class="nt">--option</span> require-sigs <span class="nb">false
</span>these paths will be fetched <span class="o">(</span>0.03 MiB download, 0.18 MiB unpacked<span class="o">)</span>:
  /nix/store/czf8l5nlp2kaag96hb42qvqd85glr8f8-lolhello
copying path <span class="s1">'/nix/store/czf8l5nlp2kaag96hb42qvqd85glr8f8-lolhello'</span> from <span class="s1">'s3://nix-cache-testing'</span>...
/nix/store/czf8l5nlp2kaag96hb42qvqd85glr8f8-lolhello
</code></pre></div></div>

<p>üéâ Nice! That was surprisingly straightforward to setup GCS as our Nix binary cache pretending to be S3.</p>

<p>üì£ Shoutout to my colleague <a href="https://www.linkedin.com/in/micah-catlin-0718991">Micah Catlin</a> who did a proof of concept originally and
introduced me to the interoperability support of GCS.</p>

<h3 id="addendum">Addendum</h3>

<p>Originally I spent quite a while trying the demo above with a different demo derivation that used a <em>trivial builder</em>.</p>
<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nv">pkgs</span> <span class="o">=</span> <span class="kr">import</span> <span class="o">&lt;</span><span class="nv">nixpkgs</span><span class="o">&gt;</span> <span class="p">{};</span>
<span class="kn">in</span>
<span class="nv">pkgs</span><span class="o">.</span><span class="nv">writeShellScriptBin</span> <span class="s2">"ping"</span>
<span class="s2">''</span><span class="err">
</span><span class="s2">echo "pong"</span><span class="err">
</span><span class="s2">''</span>
</code></pre></div></div>

<p>I could not figure out why it was not substituting from my binary cache though! üò´
Turns out that some of the <a href="https://github.com/NixOS/nixpkgs/blob/d26902aef932e80eb772026433af13ce662e7872/pkgs/build-support/trivial-builders.nix#L16">trivial builders</a> disable realization from a store and prefer locally building.</p>

<p><em>That was quite a bit of wasted time investigating‚Ä¶</em></p>


<hr />
    </article>
</div>

<div class="sidebar">
    <hr class="visible-xs" />
    <img class="avatar" src="/assets/images/avatar-164.png" alt="A photo of my dog Moose" title="My dog Moose"/>
    <p>I'm a software engineer, father and wishful amateur surfer. If you've come seeking my political views; you've found the wrong <a href="https://fareedzakaria.com/">Fareed</a>.</p>
    <div class="external-links">
      <p>
        <span class="context">linkedin</span>
        <a href="https://www.linkedin.com/in/fmzakari/">fmzakari</a>
      </p>
      <p>
        <span class="context">github</span>
        <a href="https://github.com/fzakaria">fzakaria</a>
      </p>
      <p>
        <span class="context">email</span>
        <a href="mailto:farid.m.zakaria@gmail.com">farid.m.zakaria@gmail.com</a>
      </p>
      <p>
        <span class="context">pgp</span>
        <a href="/publickey.txt">D1B232E7</a>
      </p>
      <p>
        <a href="/archive">Archive</a>
      </p>
      <p>
        <a href="/old_blog/">Historic WordPress Blog</a>
      </p>
      <!--
      <p>
        Web friendly version of my <a href="/resume/index.html">resume</a>.
      </p>
    </div>
    <h3>Projects</h3>
    <p>
      <a href="/projects/">Click here</a> for some personal
      projects I've worked on.
    </p>
    <h3>Old Blog</h3>
    <p>
      <a href="/old_blog/">Click here</a> for the archive
      of my old blog posts from Wordpress.
    </p>
    -->
    
    <h3>Recent Posts</h3>
    
    <div class="post-stub">
      2025-02-02<br />
      <a href="/2025/02/02/nix-string-interpolation-of-directories-gone-awry.html">Nix: string interpolation of directories gone awry</a>
    </div>
    
    <div class="post-stub">
      2025-01-28<br />
      <a href="/2025/01/28/bazel-build-event-protocol-viewer.html">Bazel: Build Event Protocol Viewer</a>
    </div>
    
    <div class="post-stub">
      2025-01-12<br />
      <a href="/2025/01/12/bazel-knowledge-be-mindful-of-build-without-the-bytes.html">Bazel Knowledge: Be mindful of Build Without the Bytes (bwob)</a>
    </div>
    
    
    <h3>License</h3>
    <p style="font-size: 10pt">
    The content for this site is
    <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>.
    The <a href="https://github.com/SirCmpwn/ddjekyll">inspiration for the theme</a> for this site is
    ¬© Drew Devault.
    </p>
    <div class="spacer" style="margin-top: 30px;"></div>
    
    <p><a href="https://github.com/fzakaria/fzakaria.com/edit/master/_posts/2021-06-22-setting-up-a-nix-google-cloud-storage-gcs-binary-cache.md">
      Improve this page @ 417ff2d
    </a></p>

</div>
        </div>
    </body>
</html>
