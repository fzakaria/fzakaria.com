<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Java, Nix &amp; Reproducibility | Farid Zakaria’s Blog</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Java, Nix &amp; Reproducibility" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I’ve written a lot about NixOS; specifically about some of the work I’ve done to improve the Java ecosystem. In fact, I’ve upstreamed my notes into the Java Maven Nixpkgs documentation. 🎉 Recently, the minimal ISO for NixOS has become reproducible (r13y). 🎉 The ability to produce binary reproducible artifacts is a powerful primitive. What does it take for the JVM ecosystem to adopt reproducible builds within the Nix environment? For rationale on the why, please see https://reproducible-builds.org/" />
<meta property="og:description" content="I’ve written a lot about NixOS; specifically about some of the work I’ve done to improve the Java ecosystem. In fact, I’ve upstreamed my notes into the Java Maven Nixpkgs documentation. 🎉 Recently, the minimal ISO for NixOS has become reproducible (r13y). 🎉 The ability to produce binary reproducible artifacts is a powerful primitive. What does it take for the JVM ecosystem to adopt reproducible builds within the Nix environment? For rationale on the why, please see https://reproducible-builds.org/" />
<link rel="canonical" href="https://fzakaria.com/2021/06/27/java-nix-reproducibility.html" />
<meta property="og:url" content="https://fzakaria.com/2021/06/27/java-nix-reproducibility.html" />
<meta property="og:site_name" content="Farid Zakaria’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-06-27T19:01:00-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Java, Nix &amp; Reproducibility" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-06-27T19:01:00-07:00","datePublished":"2021-06-27T19:01:00-07:00","description":"I’ve written a lot about NixOS; specifically about some of the work I’ve done to improve the Java ecosystem. In fact, I’ve upstreamed my notes into the Java Maven Nixpkgs documentation. 🎉 Recently, the minimal ISO for NixOS has become reproducible (r13y). 🎉 The ability to produce binary reproducible artifacts is a powerful primitive. What does it take for the JVM ecosystem to adopt reproducible builds within the Nix environment? For rationale on the why, please see https://reproducible-builds.org/","headline":"Java, Nix &amp; Reproducibility","mainEntityOfPage":{"@type":"WebPage","@id":"https://fzakaria.com/2021/06/27/java-nix-reproducibility.html"},"url":"https://fzakaria.com/2021/06/27/java-nix-reproducibility.html"}</script>
<!-- End Jekyll SEO tag -->

        <link type="application/atom+xml" rel="alternate" href="https://fzakaria.com/feed.xml" title="Farid Zakaria&apos;s Blog" />
        <link rel="stylesheet" type="text/css" href="/assets/css/base.css">
        <link rel="icon" type="image/x-icon" href="/assets/images/avatar.ico">
        <link rel="alternate" type="application/atom+xml" title="Farid Zakaria's Blog" href="/feed.xml">

        <link ref="">

        
        

        
            <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-35360900-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-35360900-1');
</script>

        

    </head>
    <body>
        

        <div class="container">
            <h1 class="page-title">
    <a class="rss pull-right" href="/feed.xml"><i class="fa fa-rss"></i></a>
    Java, Nix & Reproducibility
</h1>

<div class="content">
    
    <p class="date">
        Published 2021-06-27
        on <a href="/">Farid Zakaria's Blog</a>
        <span class="hidden-xs">
          &mdash;
          <a href="/2021/06/27/java-nix-reproducibility.html">
            Permalink
          </a>
        </span>
    </p>
    
    <article>
      <p>I’ve written <em>a lot</em> about NixOS; specifically about some of the work I’ve done to improve the Java ecosystem.</p>

<blockquote>
  <p>In fact, I’ve upstreamed my notes into the <a href="https://nixos.org/manual/nixpkgs/unstable/#maven">Java Maven Nixpkgs documentation</a>.</p>
</blockquote>

<p>🎉 Recently, the minimal ISO for NixOS <a href="https://web.archive.org/web/20210620180034/https://r13y.com/">has become reproducible (r13y)</a>. 🎉</p>

<p>The ability to produce binary reproducible artifacts is a powerful primitive. What does it take for the JVM ecosystem to adopt reproducible builds within the Nix environment?</p>

<blockquote>
  <p>For rationale on the <em>why</em>, please see <a href="https://reproducible-builds.org/">https://reproducible-builds.org/</a></p>
</blockquote>

<!--more-->

<p>Traditionally, Nix’s primary model for addressing artifacts is via the <em>input-addressed store</em> or <em>extensional model</em>; where the name of the package  (cryptographic hash) is derived from it’s dependencies, own package description and sources. Put simply, <strong>the <em>/nix/store/</em> path-entry is deterministic irrespective of whether the contents are deterministic</strong>.</p>

<p>This model is pragmatic since in practice, many binary differences are irrelevant (timestamps) however it leads to very pessimistic rebuilds of the source graph.</p>

<blockquote>
  <p>Consider the example where a <em>comment</em> is added to a source dependency deep in the dependency graph; this would cause the whole graph to rebuild! If we knew the binary output was the same even with the comment added, we can avoid rebuilding all upstream dependencies.</p>
</blockquote>

<p>Where does Java/Maven fit in!?
Let’s start with a very simple application.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- pom.xml --&gt;</span>
<span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
        <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.nixos<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>nixos-java-maven-r8<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;packaging&gt;</span>jar<span class="nt">&lt;/packaging&gt;</span>
  <span class="nt">&lt;name&gt;</span>NixOS Java Maven Reproducibility<span class="nt">&lt;/name&gt;</span>

  <span class="nt">&lt;properties&gt;</span>
    <span class="nt">&lt;maven.compiler.target&gt;</span>1.8<span class="nt">&lt;/maven.compiler.target&gt;</span>
    <span class="nt">&lt;maven.compiler.source&gt;</span>1.8<span class="nt">&lt;/maven.compiler.source&gt;</span>
  <span class="nt">&lt;/properties&gt;</span>

  <span class="nt">&lt;dependencies&gt;</span>

  <span class="nt">&lt;/dependencies&gt;</span>

  <span class="nt">&lt;build&gt;</span>
  <span class="nt">&lt;plugins&gt;</span>
    <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>maven-jar-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>3.2.0<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;configuration&gt;</span>
            <span class="nt">&lt;archive&gt;</span>
                <span class="nt">&lt;manifest&gt;</span>
                    <span class="nt">&lt;mainClass&gt;</span>Main<span class="nt">&lt;/mainClass&gt;</span>
                <span class="nt">&lt;/manifest&gt;</span>
            <span class="nt">&lt;/archive&gt;</span>
        <span class="nt">&lt;/configuration&gt;</span>
    <span class="nt">&lt;/plugin&gt;</span>
  <span class="nt">&lt;/plugins&gt;</span>
<span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// src/main/java/Main.java</span>
<span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">){</span>
     <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Hello NixOS!"</span><span class="o">);</span>
   <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span> <span class="nv">pkgs</span> <span class="o">?</span> <span class="kr">import</span> <span class="o">&lt;</span><span class="nv">nixpkgs</span><span class="o">&gt;</span> <span class="p">{</span> <span class="p">},</span> <span class="nv">stdenv</span> <span class="o">?</span> <span class="nv">pkgs</span><span class="o">.</span><span class="nv">stdenv</span><span class="p">,</span> <span class="nv">lib</span> <span class="o">?</span> <span class="nv">pkgs</span><span class="o">.</span><span class="nv">lib</span>
<span class="p">,</span> <span class="nv">maven</span> <span class="o">?</span> <span class="nv">pkgs</span><span class="o">.</span><span class="nv">maven</span><span class="p">,</span> <span class="nv">jre</span> <span class="o">?</span> <span class="nv">pkgs</span><span class="o">.</span><span class="nv">jre</span><span class="p">,</span> <span class="nv">makeWrapper</span> <span class="o">?</span> <span class="nv">pkgs</span><span class="o">.</span><span class="nv">makeWrapper</span> <span class="p">}:</span>
<span class="nv">stdenv</span><span class="o">.</span><span class="nv">mkDerivation</span> <span class="kr">rec</span> <span class="p">{</span>
  <span class="nv">pname</span> <span class="o">=</span> <span class="s2">"nixos-java-maven-r8"</span><span class="p">;</span>
  <span class="nv">version</span> <span class="o">=</span> <span class="s2">"1.0"</span><span class="p">;</span>

  <span class="nv">__noChroot</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="nv">src</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">cleanSourceWith</span> <span class="p">{</span>
    <span class="nv">filter</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">cleanSourceFilter</span><span class="p">;</span>
    <span class="nv">src</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">cleanSourceWith</span> <span class="p">{</span>
      <span class="nv">filter</span> <span class="o">=</span> <span class="nv">path</span><span class="p">:</span> <span class="nv">type</span><span class="p">:</span>
        <span class="o">!</span><span class="p">(</span><span class="nv">lib</span><span class="o">.</span><span class="nv">pathIsDirectory</span> <span class="p">(</span><span class="nv">path</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="kr">baseNameOf</span> <span class="p">(</span><span class="kr">toString</span> <span class="p">(</span><span class="nv">path</span><span class="p">))</span>
          <span class="o">==</span> <span class="s2">"target"</span><span class="p">);</span>
      <span class="nv">src</span> <span class="o">=</span> <span class="sx">./.</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">};</span>

  <span class="nv">buildInputs</span> <span class="o">=</span> <span class="p">[</span> <span class="nv">maven</span> <span class="nv">makeWrapper</span><span class="p">];</span>

  <span class="nv">buildPhase</span> <span class="o">=</span> <span class="s2">''</span><span class="err">
</span><span class="s2">    mvn package;</span><span class="err">
</span><span class="s2">  ''</span><span class="p">;</span>

  <span class="nv">installPhase</span> <span class="o">=</span> <span class="s2">''</span><span class="err">
</span><span class="s2">    # create the bin directory</span><span class="err">
</span><span class="s2">    mkdir -p $out/bin</span><span class="err">

</span><span class="s2">    # copy out the JAR</span><span class="err">
</span><span class="s2">    # Maven already setup the classpath to use m2 repository layout</span><span class="err">
</span><span class="s2">    # with the prefix of lib/</span><span class="err">
</span><span class="s2">    cp target/</span><span class="si">${</span><span class="nv">pname</span><span class="si">}</span><span class="s2">-</span><span class="si">${</span><span class="nv">version</span><span class="si">}</span><span class="s2">.jar $out/</span><span class="err">

</span><span class="s2">    # create a wrapper that will automatically call the jar</span><span class="err">
</span><span class="s2">    makeWrapper </span><span class="si">${</span><span class="nv">jre</span><span class="si">}</span><span class="s2">/bin/java $out/bin/</span><span class="si">${</span><span class="nv">pname</span><span class="si">}</span><span class="s2"> \</span><span class="err">
</span><span class="s2">          --add-flags "-jar $out/</span><span class="si">${</span><span class="nv">pname</span><span class="si">}</span><span class="s2">-</span><span class="si">${</span><span class="nv">version</span><span class="si">}</span><span class="s2">.jar"</span><span class="err">
</span><span class="s2">  ''</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Nothing surprising here if you’ve read the Maven Nixpkgs documentation. The one <em>simplification</em> is the use of <code class="language-plaintext highlighter-rouge">__noChroot</code> which disables sandboxing.
This is to make the use of <em>Maven</em> a bit simpler for education purposes.</p>

<p>Let’s build!</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nix-build build.nix <span class="nt">--option</span> sandbox relaxed <span class="nt">--no-out-link</span>
... bunch of output omitted ...
/nix/store/g1bgxhr84ldag0hyshlz3r7aagq551f8-nixos-java-maven-r8-1.0
</code></pre></div></div>

<p>We can then ask Nix to validate that our derivation is <em>binary reproducible</em>.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nix-build build.nix <span class="nt">--option</span> sandbox relaxed <span class="nt">--no-out-link</span> <span class="nt">--check</span> <span class="nt">--keep-failed</span>
... bunch of output omitted ...
derivation <span class="s1">'/nix/store/7hfkwwdb5y4llbgykb3dgnb2hy5xwww4-nixos-java-maven-r8-1.0.drv'</span> may not be deterministic: output <span class="s1">'/nix/store/g1bgxhr84ldag0hyshlz3r7aagq551f8-nixos-java-maven-r8-1.0'</span> differs from <span class="s1">'/nix/store/g1bgxhr84ldag0hyshlz3r7aagq551f8-nixos-java-maven-r8-1.0.check'</span>
note: keeping build directory <span class="s1">'/tmp/nix-build-nixos-java-maven-r8-1.0.drv-4'</span>
error: build of <span class="s1">'/nix/store/7hfkwwdb5y4llbgykb3dgnb2hy5xwww4-nixos-java-maven-r8-1.0.drv'</span> failed
</code></pre></div></div>

<p>😮 We’ve hit an error identifying that our build <em>may not be deterministic</em>. Let’s use <a href="https://diffoscope.org/">diffoscope</a> to dig into why.</p>

<p><img src="/assets/images/maven-diff-r13y.png" alt="VPN graphic" /></p>

<p>Looks like there is a difference due to timestamps.</p>

<p>The JAR archive format is based on the ZIP archive format, which is <a href="https://wiki.debian.org/ReproducibleBuilds/TimestampsInZip">known not to be binary reproducible</a>.
The ZIP archive format record mtimes of the packed files, which will prevent reproducibility.</p>

<blockquote>
  <p>This is in fact why Nix has it’s own archive format, <em>Nix Archive</em> (NAR), that addresses typical non-determinism issues with archive formats.</p>
</blockquote>

<p>Luckily, Maven itself <a href="https://maven.apache.org/guides/mini/guide-reproducible-builds.html">has the ability</a> to force-set these timestamps and enable reproducible builds.</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- We add this to our properties, set it to any time you see fit --&gt;</span>
<span class="nt">&lt;project.build.outputTimestamp&gt;</span>1<span class="nt">&lt;/project.build.outputTimestamp&gt;</span>
</code></pre></div></div>

<p>If we try the build again, we are now reproducible.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># let's repeat the build three times</span>
❯ nix-build build.nix <span class="nt">--option</span> sandbox relaxed <span class="nt">--no-out-link</span> <span class="nt">--option</span> repeat 3 <span class="nt">--option</span> enforce-determinism <span class="nb">true
</span>building <span class="s1">'/nix/store/yvvia00l1vls1qkgypikvjivn2ash498-nixos-java-maven-r8-1.0.drv'</span> <span class="o">(</span>round 1/4<span class="o">)</span>...
building <span class="s1">'/nix/store/yvvia00l1vls1qkgypikvjivn2ash498-nixos-java-maven-r8-1.0.drv'</span> <span class="o">(</span>round 2/4<span class="o">)</span>...
building <span class="s1">'/nix/store/yvvia00l1vls1qkgypikvjivn2ash498-nixos-java-maven-r8-1.0.drv'</span> <span class="o">(</span>round 3/4<span class="o">)</span>...
building <span class="s1">'/nix/store/yvvia00l1vls1qkgypikvjivn2ash498-nixos-java-maven-r8-1.0.drv'</span> <span class="o">(</span>round 4/4<span class="o">)</span>...
/nix/store/ws9flbiil6226lx5ifb1yfd3gijcz27j-nixos-java-maven-r8-1.0
</code></pre></div></div>

<p>This may all seem very <em>pedantic</em>, however I ran into the crux of having JARs non-deterministic when building out <a href="https://github.com/fzakaria/mvn2nix">mvn2nix</a>.</p>

<p>Gradle has an interesting call out in <a href="https://docs.gradle.org/current/userguide/dependency_verification.html#sec:trusting-several-checksums">its documentation</a>, for the problem I encountered.</p>
<blockquote>
  <p>It’s quite common to have different checksums for the same artifact in the wild. How is that possible? Despite progress, it’s often the case that developers publish, for example, to Maven Central and another repository separately, using different builds.</p>
</blockquote>

<p>That means that <strong>you cannot guarantee</strong> that a JAR published on one Maven artifactory, will give you the same binary content from another, <strong>for the exact same version</strong>.</p>

<p><img src="https://media.giphy.com/media/LpLd2NGvpaiys/giphy.gif" alt="mind-blown" /></p>

<p>Reproducible builds provide a lot of benefit. While making a build deterministic is not always feasible, and a touch of pragmatism is useful, we should provide tooling to make it simpler when possible.</p>

<p><em>Better yet, have the default be determinism.</em></p>

<blockquote>
  <p>Should we track in Maven Central which packages are reproducible?</p>
</blockquote>

<h2 id="alternative">Alternative</h2>

<p>We could also make the JAR (ZIP) archive deterministic using Debian’s <a href="https://tracker.debian.org/pkg/strip-nondeterminism">strip-nondeterminism</a> script.</p>

<blockquote>
  <p>🧐 Should this script be included by default in the <em>fixupPhase</em> ?</p>
</blockquote>

<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">postFixup</span> <span class="o">=</span> <span class="s2">''</span><span class="err">
</span><span class="s2">  # Removing the nondeterminism</span><span class="err">
</span><span class="s2">  </span><span class="si">${</span><span class="nv">strip-nondeterminism</span><span class="si">}</span><span class="s2">/bin/strip-nondeterminism $out/</span><span class="si">${</span><span class="nv">pname</span><span class="si">}</span><span class="s2">-</span><span class="si">${</span><span class="nv">version</span><span class="si">}</span><span class="s2">.jar</span><span class="err">
</span><span class="s2">''</span><span class="p">;</span>
</code></pre></div></div>


<hr />
    </article>
</div>

<div class="sidebar">
    <hr class="visible-xs" />
    <img class="avatar" src="/assets/images/avatar-164.png" alt="A photo of my dog Moose" title="My dog Moose"/>
    <p>I'm a software engineer, father and wishful amateur surfer. If you've come seeking my political views; you've found the wrong <a href="https://fareedzakaria.com/">Fareed</a>.</p>
    <div class="external-links">
      <p>
        <span class="context">linkedin</span>
        <a href="https://www.linkedin.com/in/fmzakari/">fmzakari</a>
      </p>
      <p>
        <span class="context">github</span>
        <a href="https://github.com/fzakaria">fzakaria</a>
      </p>
      <p>
        <span class="context">email</span>
        <a href="mailto:farid.m.zakaria@gmail.com">farid.m.zakaria@gmail.com</a>
      </p>
      <p>
        <span class="context">pgp</span>
        <a href="/publickey.txt">D1B232E7</a>
      </p>
      <p>
        <a href="/archive">Archive</a>
      </p>
      <p>
        <a href="/old_blog/">Historic WordPress Blog</a>
      </p>
      <!--
      <p>
        Web friendly version of my <a href="/resume/index.html">resume</a>.
      </p>
    </div>
    <h3>Projects</h3>
    <p>
      <a href="/projects/">Click here</a> for some personal
      projects I've worked on.
    </p>
    <h3>Old Blog</h3>
    <p>
      <a href="/old_blog/">Click here</a> for the archive
      of my old blog posts from Wordpress.
    </p>
    -->
    
    <h3>Recent Posts</h3>
    
    <div class="post-stub">
      2025-02-02<br />
      <a href="/2025/02/02/nix-string-interpolation-of-directories-gone-awry.html">Nix: string interpolation of directories gone awry</a>
    </div>
    
    <div class="post-stub">
      2025-01-28<br />
      <a href="/2025/01/28/bazel-build-event-protocol-viewer.html">Bazel: Build Event Protocol Viewer</a>
    </div>
    
    <div class="post-stub">
      2025-01-12<br />
      <a href="/2025/01/12/bazel-knowledge-be-mindful-of-build-without-the-bytes.html">Bazel Knowledge: Be mindful of Build Without the Bytes (bwob)</a>
    </div>
    
    
    <h3>License</h3>
    <p style="font-size: 10pt">
    The content for this site is
    <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>.
    The <a href="https://github.com/SirCmpwn/ddjekyll">inspiration for the theme</a> for this site is
    © Drew Devault.
    </p>
    <div class="spacer" style="margin-top: 30px;"></div>
    
    <p><a href="https://github.com/fzakaria/fzakaria.com/edit/master/_posts/2021-06-27-java-nix-reproducibility.md">
      Improve this page @ 417ff2d
    </a></p>

</div>
        </div>
    </body>
</html>
