<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>My C++ Class Idiom Gotcha | Farid Zakaria’s Blog</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="My C++ Class Idiom Gotcha" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Idiom: Classes Definitely I get trapped into a C++ style of thinking; or rather an object-oriented style of thinking. I&#39;m still a fan of object oriented programming (although I have read post after post about how wonderful functional programming is), however I&#39;ve ran into a gotcha at work because of it. &lt;/br&gt; &quot;gotcha&quot; has become a term for a feature of a programming language that is likely to play tricks on you to display behavior that is different than what you expect. What I wanted to do We had a very small structure representing a 4D float Vector. I began to use it however decided that I wanted to add a few more methods, a constructor etc... Therefore I decided to turn my nice lean small structure into a Class! struct Vector { float x; float y; float z; float w; }; became... class Vector4f { public: union { struct { float x; float y; float z; float w; }; struct { float X; float Y; float Z; float W; }; FLOAT data[4]; }; Vector4f(); Vector4f(float x, float y, float z, float w); virtual ~Vector4f() {}" />
<meta property="og:description" content="Idiom: Classes Definitely I get trapped into a C++ style of thinking; or rather an object-oriented style of thinking. I&#39;m still a fan of object oriented programming (although I have read post after post about how wonderful functional programming is), however I&#39;ve ran into a gotcha at work because of it. &lt;/br&gt; &quot;gotcha&quot; has become a term for a feature of a programming language that is likely to play tricks on you to display behavior that is different than what you expect. What I wanted to do We had a very small structure representing a 4D float Vector. I began to use it however decided that I wanted to add a few more methods, a constructor etc... Therefore I decided to turn my nice lean small structure into a Class! struct Vector { float x; float y; float z; float w; }; became... class Vector4f { public: union { struct { float x; float y; float z; float w; }; struct { float X; float Y; float Z; float W; }; FLOAT data[4]; }; Vector4f(); Vector4f(float x, float y, float z, float w); virtual ~Vector4f() {}" />
<link rel="canonical" href="https://fzakaria.com/old_blog/2011-11-16-my-c-class-idiom-gotcha.html" />
<meta property="og:url" content="https://fzakaria.com/old_blog/2011-11-16-my-c-class-idiom-gotcha.html" />
<meta property="og:site_name" content="Farid Zakaria’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2011-11-16T12:03:50-08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="My C++ Class Idiom Gotcha" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2011-11-16T12:03:50-08:00","datePublished":"2011-11-16T12:03:50-08:00","description":"Idiom: Classes Definitely I get trapped into a C++ style of thinking; or rather an object-oriented style of thinking. I&#39;m still a fan of object oriented programming (although I have read post after post about how wonderful functional programming is), however I&#39;ve ran into a gotcha at work because of it. &lt;/br&gt; &quot;gotcha&quot; has become a term for a feature of a programming language that is likely to play tricks on you to display behavior that is different than what you expect. What I wanted to do We had a very small structure representing a 4D float Vector. I began to use it however decided that I wanted to add a few more methods, a constructor etc... Therefore I decided to turn my nice lean small structure into a Class! struct Vector { float x; float y; float z; float w; }; became... class Vector4f { public: union { struct { float x; float y; float z; float w; }; struct { float X; float Y; float Z; float W; }; FLOAT data[4]; }; Vector4f(); Vector4f(float x, float y, float z, float w); virtual ~Vector4f() {}","headline":"My C++ Class Idiom Gotcha","mainEntityOfPage":{"@type":"WebPage","@id":"https://fzakaria.com/old_blog/2011-11-16-my-c-class-idiom-gotcha.html"},"url":"https://fzakaria.com/old_blog/2011-11-16-my-c-class-idiom-gotcha.html"}</script>
<!-- End Jekyll SEO tag -->

        <link type="application/atom+xml" rel="alternate" href="https://fzakaria.com/feed.xml" title="Farid Zakaria&apos;s Blog" />
        <link rel="stylesheet" type="text/css" href="/assets/css/base.css">
        <link rel="icon" type="image/x-icon" href="/assets/images/avatar.ico">
        <link rel="alternate" type="application/atom+xml" title="Farid Zakaria's Blog" href="/feed.xml">

        <link ref="">

        
        
        <link href="/assets/css/highlightjs-default-theme.css" rel="stylesheet" />
        

        
            <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-35360900-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-35360900-1');
</script>

        

    </head>
    <body>
        
        <script src="/assets/js/highlight.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        

        <div class="container">
            <h1 class="page-title">
    <a class="rss pull-right" href="/feed.xml"><i class="fa fa-rss"></i></a>
    My C++ Class Idiom Gotcha
</h1>

<div class="content">
    
    <p class="date">
        Published 2011-11-16
        on <a href="/">Farid Zakaria's Blog</a>
        <span class="hidden-xs">
          &mdash;
          <a href="/old_blog/2011-11-16-my-c-class-idiom-gotcha.html">
            Permalink
          </a>
        </span>
    </p>
    
    <article>
      <h2> Idiom: Classes </h2>
<p>
<a href="http://fzakaria-blog.elasticbeanstalk.com/wp-content/uploads/2011/11/Preview.jpg"><img src="http://fzakaria-blog.elasticbeanstalk.com/wp-content/uploads/2011/11/Preview.jpg" alt="" title="All The things" width="200" height="150" class="alignleft size-full wp-image-919" /></a> Definitely I get trapped into a C++ style of thinking; or rather an object-oriented style of thinking. I'm still a fan of object oriented programming (although I have read post after post about how <em>wonderful</em> functional programming is), however I've ran into a <strong>gotcha </strong>at work because of it.</p>
<p></br></p>
<blockquote><p>"<em>gotcha</em>" has become a term for a feature of a programming language that is likely to play tricks on you to display behavior that is different than what you expect.</p></blockquote>
<p><!--more--></p>
<h3>What I wanted to do </h3>
<p>
We had a very small structure representing a 4D float Vector. I began to use it however decided that I wanted to add a few more methods, a constructor etc... Therefore I decided to turn my nice lean small structure into a <strong>Class</strong>!</p>
<pre>
<code>
struct Vector
{
float x;
float y;
float z;
float w;
};
</code>
</pre>
<p><em>became...</em></p>
<pre>
<code>
class Vector4f
{
public:
    union
    {
        struct  
        {
            float x;
            float y;
            float z;
            float w;
        };
        struct 
        {
            float X;
            float Y;
            float Z;
            float W;
        };
        FLOAT data[4];
    };
    Vector4f();
    Vector4f(float x, float y, float z, float w);
    virtual ~Vector4f() {}

    static Vector4f Zero() { return m_zeroVector; }

    Vector4f Add(const Vector4f & vector2) const;
    Vector4f operator+(const Vector4f & vector2) const;
    float & operator[](unsigned int component);
    float const & operator[](unsigned int component) const;
private:
    const static Vector4f m_zeroVector;
};
</code>
</pre></p>
<p>
C++ is an object-oriented language, thus I have the tendency to wrap everything in a Class rather than a Struct so that I can extend them and it is more inline with the OO-idiom. This has generally been fine for most code I've written however my work has a lot of mixing between C and C++ coding (multimedia driver development for those curious).</p>
<p>
My OO-idiom failed me with the use of <a href="http://www.cplusplus.com/reference/clibrary/cstring/memcpy/">memcpy</a>. Many assignment operations in the codebase are done via memcpy instead of the assignment operator.</p>
<pre>
<code>
float data[4];
Vector4f vector4;
memcpy(&data, &vector4, sizeof(Vector4f)); //OUT OF BOUNDS
</code>
</pre>
<p>
The culprit is <strong>line 24</strong> in the definition of the Vector4f class. Adding <em>virtual</em> to a method, causes the class definition to contain an additional vbptr (virtual base pointer). It caused the size of the class to go from 16 to 20 (assuming 4byte pointer). It was from force of habit of always including virtual in the destructor, which is itself another <strong>gotcha</strong>!</p>
<p>
Whether what I encountered is a valid <em>gotcha</em> or me just being <del datetime="2011-11-16T16:30:20+00:00">an idiot</del> inexperienced, I haven't decided. For now, I've added a static assert (compile time assert) to verify the sizeof the class is as expected in case someone in the future decides to redo my blunder.</p>


<hr />
    </article>
</div>

<div class="sidebar">
    <hr class="visible-xs" />
    <img class="avatar" src="/assets/images/avatar-164.png" alt="A photo of my dog Moose" title="My dog Moose"/>
    <p>I'm a software engineer, father and wishful amateur surfer. If you've come seeking my political views; you've found the wrong <a href="https://fareedzakaria.com/">Fareed</a>.</p>
    <div class="external-links">
      <p>
        <span class="context">linkedin</span>
        <a href="https://www.linkedin.com/in/fmzakari/">fmzakari</a>
      </p>
      <p>
        <span class="context">github</span>
        <a href="https://github.com/fzakaria">fzakaria</a>
      </p>
      <p>
        <span class="context">email</span>
        <a href="mailto:farid.m.zakaria@gmail.com">farid.m.zakaria@gmail.com</a>
      </p>
      <p>
        <span class="context">pgp</span>
        <a href="/publickey.txt">D1B232E7</a>
      </p>
      <p>
        <a href="/archive">Archive</a>
      </p>
      <p>
        <a href="/old_blog/">Historic WordPress Blog</a>
      </p>
      <!--
      <p>
        Web friendly version of my <a href="/resume/index.html">resume</a>.
      </p>
    </div>
    <h3>Projects</h3>
    <p>
      <a href="/projects/">Click here</a> for some personal
      projects I've worked on.
    </p>
    <h3>Old Blog</h3>
    <p>
      <a href="/old_blog/">Click here</a> for the archive
      of my old blog posts from Wordpress.
    </p>
    -->
    
    <h3>Recent Posts</h3>
    
    <div class="post-stub">
      2025-02-02<br />
      <a href="/2025/02/02/nix-string-interpolation-of-directories-gone-awry.html">Nix: string interpolation of directories gone awry</a>
    </div>
    
    <div class="post-stub">
      2025-01-28<br />
      <a href="/2025/01/28/bazel-build-event-protocol-viewer.html">Bazel: Build Event Protocol Viewer</a>
    </div>
    
    <div class="post-stub">
      2025-01-12<br />
      <a href="/2025/01/12/bazel-knowledge-be-mindful-of-build-without-the-bytes.html">Bazel Knowledge: Be mindful of Build Without the Bytes (bwob)</a>
    </div>
    
    
    <h3>License</h3>
    <p style="font-size: 10pt">
    The content for this site is
    <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>.
    The <a href="https://github.com/SirCmpwn/ddjekyll">inspiration for the theme</a> for this site is
    © Drew Devault.
    </p>
    <div class="spacer" style="margin-top: 30px;"></div>
    
    <p><a href="https://github.com/fzakaria/fzakaria.com/edit/master/_old_blog/2011-11-16-my-c-class-idiom-gotcha.html">
      Improve this page @ 417ff2d
    </a></p>

</div>
        </div>
    </body>
</html>
