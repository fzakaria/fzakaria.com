<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Quick insights using sqlelf | Farid Zakaria’s Blog</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Quick insights using sqlelf" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Please checkout the sqlelf repository and give me your feedback. I wrote in my earlier post about releasing sqlelf. I had the hunch that the existing tooling we have to interface with our object formats, such as ELF, are antiquated and ill specified. Declarative languages, such as SQL, are such a wonderful abstraction to articulate over data layouts and let you reason about what you want rather than how to get it. Since continuing to noodle 👨‍💻 on the project, I’ve been pleasantly surprised at some of the introspection, specifically with respect to symbols, I’ve been able to accomplish with SQL that would have been a pain using traditional tools." />
<meta property="og:description" content="Please checkout the sqlelf repository and give me your feedback. I wrote in my earlier post about releasing sqlelf. I had the hunch that the existing tooling we have to interface with our object formats, such as ELF, are antiquated and ill specified. Declarative languages, such as SQL, are such a wonderful abstraction to articulate over data layouts and let you reason about what you want rather than how to get it. Since continuing to noodle 👨‍💻 on the project, I’ve been pleasantly surprised at some of the introspection, specifically with respect to symbols, I’ve been able to accomplish with SQL that would have been a pain using traditional tools." />
<link rel="canonical" href="https://fzakaria.com/2023/09/11/quick-insights-using-sqlelf.html" />
<meta property="og:url" content="https://fzakaria.com/2023/09/11/quick-insights-using-sqlelf.html" />
<meta property="og:site_name" content="Farid Zakaria’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-09-11T14:12:00-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Quick insights using sqlelf" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-09-11T14:12:00-07:00","datePublished":"2023-09-11T14:12:00-07:00","description":"Please checkout the sqlelf repository and give me your feedback. I wrote in my earlier post about releasing sqlelf. I had the hunch that the existing tooling we have to interface with our object formats, such as ELF, are antiquated and ill specified. Declarative languages, such as SQL, are such a wonderful abstraction to articulate over data layouts and let you reason about what you want rather than how to get it. Since continuing to noodle 👨‍💻 on the project, I’ve been pleasantly surprised at some of the introspection, specifically with respect to symbols, I’ve been able to accomplish with SQL that would have been a pain using traditional tools.","headline":"Quick insights using sqlelf","mainEntityOfPage":{"@type":"WebPage","@id":"https://fzakaria.com/2023/09/11/quick-insights-using-sqlelf.html"},"url":"https://fzakaria.com/2023/09/11/quick-insights-using-sqlelf.html"}</script>
<!-- End Jekyll SEO tag -->

        <link type="application/atom+xml" rel="alternate" href="https://fzakaria.com/feed.xml" title="Farid Zakaria&apos;s Blog" />
        <link rel="stylesheet" type="text/css" href="/assets/css/base.css">
        <link rel="icon" type="image/x-icon" href="/assets/images/avatar.ico">
        <link rel="alternate" type="application/atom+xml" title="Farid Zakaria's Blog" href="/feed.xml">

        <link ref="">

        
        

        
            <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-35360900-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-35360900-1');
</script>

        

    </head>
    <body>
        

        <div class="container">
            <h1 class="page-title">
    <a class="rss pull-right" href="/feed.xml"><i class="fa fa-rss"></i></a>
    Quick insights using sqlelf
</h1>

<div class="content">
    
    <p class="date">
        Published 2023-09-11
        on <a href="/">Farid Zakaria's Blog</a>
        <span class="hidden-xs">
          &mdash;
          <a href="/2023/09/11/quick-insights-using-sqlelf.html">
            Permalink
          </a>
        </span>
    </p>
    
    <article>
      <blockquote>
  <p>Please checkout the <a href="https://github.com/fzakaria/sqlelf">sqlelf</a> repository and give me your feedback.</p>
</blockquote>

<p>I wrote in my earlier <a href="/2023/03/19/sqlelf-and-20-years-of-nix.html">post</a> about releasing <a href="https://github.com/fzakaria/sqlelf">sqlelf</a>.
I had the hunch that the existing tooling we have to interface with our object formats, such as ELF, are antiquated and ill specified.</p>

<p>Declarative languages, such as SQL, are such a wonderful abstraction to articulate over data layouts and let you reason about <em>what you want</em> rather than <em>how to get it</em>.</p>

<p>Since continuing to noodle 👨‍💻 on the project, I’ve been pleasantly surprised at some of the introspection, specifically with respect to symbols, I’ve been able
to accomplish with SQL that would have been a pain using traditional tools.</p>

<!--more-->

<p>Come on a stroll with me on a few case studies I’ve gone through on how SQL guided analysis wins out.</p>

<h2 id="symbol-resolution">Symbol Resolution</h2>

<p>One of the primary data structures within the ELF file is the symbol table, especially the <em>dynamic symbol table</em> that allows the use of shared objects (libraries).</p>

<p>A typical question someone may ask themselves though is:</p>

<p><strong>Which library that I load is providing <em>function foo</em>?</strong></p>

<p>This is a worthwhile question because you would like to know which shared object is not only providing the symbol definition but also which the linker (<code class="language-plaintext highlighter-rouge">ld.so</code>) chooses
to link against at runtime.</p>

<p>The <em>state of the art</em> (prior to sqlelf) of how to retrieve this diagnostic information is using <code class="language-plaintext highlighter-rouge">LD_DEBUG</code> environment variable and trolling through the large dump of logs it emits. 🤦</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">❯ LD_DEBUG=symbols,bindings /usr/bin/ruby |&amp; head
</span><span class="gp">   1228310:	symbol=__vdso_clock_gettime;</span><span class="w">  </span>lookup <span class="k">in </span><span class="nv">file</span><span class="o">=</span>linux-vdso.so.1 <span class="o">[</span>0]
<span class="go">   1228310:	binding file linux-vdso.so.1 [0] to linux-vdso.so.1 [0]: normal symbol `__vdso_clock_gettime' [LINUX_2.6]
</span><span class="gp">   1228310:	symbol=__vdso_gettimeofday;</span><span class="w">  </span>lookup <span class="k">in </span><span class="nv">file</span><span class="o">=</span>linux-vdso.so.1 <span class="o">[</span>0]
<span class="go">   1228310:	binding file linux-vdso.so.1 [0] to linux-vdso.so.1 [0]: normal symbol `__vdso_gettimeofday' [LINUX_2.6]
</span><span class="gp">   1228310:	symbol=__vdso_time;</span><span class="w">  </span>lookup <span class="k">in </span><span class="nv">file</span><span class="o">=</span>linux-vdso.so.1 <span class="o">[</span>0]
<span class="go">   1228310:	binding file linux-vdso.so.1 [0] to linux-vdso.so.1 [0]: normal symbol `__vdso_time' [LINUX_2.6]
</span><span class="gp">   1228310:	symbol=__vdso_getcpu;</span><span class="w">  </span>lookup <span class="k">in </span><span class="nv">file</span><span class="o">=</span>linux-vdso.so.1 <span class="o">[</span>0]
<span class="go">   1228310:	binding file linux-vdso.so.1 [0] to linux-vdso.so.1 [0]: normal symbol `__vdso_getcpu' [LINUX_2.6]
</span><span class="gp">   1228310:	symbol=__vdso_clock_getres;</span><span class="w">  </span>lookup <span class="k">in </span><span class="nv">file</span><span class="o">=</span>linux-vdso.so.1 <span class="o">[</span>0]
<span class="go">   1228310:	binding file linux-vdso.so.1 [0] to linux-vdso.so.1 [0]: normal symbol `__vdso_clock_getres' [LINUX_2.6]
</span></code></pre></div></div>

<p>Let’s see how we can re-think of this question as a declarative SQL statement:</p>

<pre><code class="language-SQL">SELECT caller.path as 'caller.path',
       callee.path as 'calee.path',
       caller.name,
       caller.demangled_name
FROM ELF_SYMBOLS caller
INNER JOIN ELF_SYMBOLS callee
ON
caller.name = callee.name AND
caller.path != callee.path AND
caller.imported = TRUE AND
callee.exported = TRUE
</code></pre>

<p>We can think of the above ask asking:</p>

<p><em>Please provide all pairings of symbols where the name is the same between any two different ELF files.
One of the files must export the symbol and the other must be importing it.</em></p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">❯ sqlelf /usr/bin/ruby --sql "SELECT caller.path as 'caller.path',
       callee.path as 'calee.path',
       caller.name
FROM ELF_SYMBOLS caller
INNER JOIN ELF_SYMBOLS callee
ON
caller.name = callee.name AND
caller.path != callee.path AND
caller.imported = TRUE AND
callee.exported = TRUE
LIMIT 10"
┌───────────────┬────────────────────────────────────────────────┬───────────────────┐
│  caller.path  │                   calee.path                   │       name        │
│ /usr/bin/ruby │ /usr/lib/x86_64-linux-gnu/libruby-3.1.so.3.1.2 │ ruby_run_node     │
│ /usr/bin/ruby │ /usr/lib/x86_64-linux-gnu/libruby-3.1.so.3.1.2 │ ruby_init         │
│ /usr/bin/ruby │ /usr/lib/x86_64-linux-gnu/libruby-3.1.so.3.1.2 │ ruby_options      │
│ /usr/bin/ruby │ /usr/lib/x86_64-linux-gnu/libruby-3.1.so.3.1.2 │ ruby_sysinit      │
│ /usr/bin/ruby │ /usr/lib/x86_64-linux-gnu/libc.so.6            │ __stack_chk_fail  │
│ /usr/bin/ruby │ /usr/lib/x86_64-linux-gnu/libruby-3.1.so.3.1.2 │ ruby_init_stack   │
│ /usr/bin/ruby │ /usr/lib/x86_64-linux-gnu/libc.so.6            │ setlocale         │
│ /usr/bin/ruby │ /usr/lib/x86_64-linux-gnu/libc.so.6            │ __libc_start_main │
│ /usr/bin/ruby │ /usr/lib/x86_64-linux-gnu/libc.so.6            │ __libc_start_main │
│ /usr/bin/ruby │ /usr/lib/x86_64-linux-gnu/libc.so.6            │ __cxa_finalize    │
└───────────────┴────────────────────────────────────────────────┴───────────────────┘
</span></code></pre></div></div>

<p>🥳 That sure beats dealing with unstructured text. sqlelf can also emit a myriad of output formats such as csv or json.</p>

<h2 id="symbol-shadowing">Symbol Shadowing</h2>

<p>The reality of <code class="language-plaintext highlighter-rouge">LD_DEBUG</code> however is that it usefulness came in knowing the <em>final resolution</em> of a given symbol.</p>

<p>ELF files are free to have and export any symbols and often times, whether by accident (benign) or maliciously, the same symbol may be exported by
multiple libraries.</p>

<blockquote>
  <p>This is what empowers tools such as <code class="language-plaintext highlighter-rouge">LD_PRELOAD</code> so that users can take over symbols such as <code class="language-plaintext highlighter-rouge">malloc</code> and replace them with alternative strategies.</p>
</blockquote>

<p>The linker, according to the <a href="https://refspecs.linuxbase.org/elf/gabi4+/ch5.dynamic.html">SystemV ABI</a>, examines the symbol tables with a breadth-first search across the dependency graph of the shared object libraries.</p>

<p>A typical question someone may ask themselves though is:</p>

<p><strong>What symbols are currently shadowed in my dependency graph?</strong></p>

<p>Let’s see how we can re-think of this question as a declarative SQL statement:</p>

<pre><code class="language-SQL">SELECT name, version, count(*) as symbol_count,
       GROUP_CONCAT(path, ':') as libraries
FROM elf_symbols
WHERE exported = TRUE
GROUP BY name, version
HAVING count(*) &gt;= 2
</code></pre>

<p>We can think of the above ask asking:</p>

<p><em>Please provide me all symbols (and the library that defines them) that are exported by more than 2 libraries</em>.</p>

<p>Any symbol here is technically being shadowed, whether on purpose or benign.</p>

<p>Revisiting the same <em>ruby</em> example above we can see the results.</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">❯ sqlelf /usr/bin/ruby --recursive --sql "
SELECT name, version, count(*) as symbol_count,
       GROUP_CONCAT(path, ':') as libraries
FROM elf_symbols
WHERE exported = TRUE
GROUP BY name, version
</span><span class="gp">HAVING count(*) &gt;</span><span class="o">=</span> 2<span class="s2">"
</span><span class="go">┌────────────┬─────────────┬──────────────┬─────────────────────────────────────────────────────────────────────────┐
│    name    │   version   │ symbol_count │                                libraries                                │
│ __finite   │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ __finitef  │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ __finitel  │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ __signbit  │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ __signbitf │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ __signbitl │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ copysign   │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ copysignf  │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ copysignl  │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ finite     │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ finitef    │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ finitel    │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ frexp      │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ frexpf     │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ frexpl     │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ ldexp      │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ ldexpf     │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ ldexpl     │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ modf       │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ modff      │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ modfl      │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ scalbn     │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ scalbnf    │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
│ scalbnl    │ GLIBC_2.2.5 │ 2            │ /usr/lib/x86_64-linux-gnu/libm.so.6:/usr/lib/x86_64-linux-gnu/libc.so.6 │
└────────────┴─────────────┴──────────────┴─────────────────────────────────────────────────────────────────────────┘
</span></code></pre></div></div>

<p>In this particular case, there is no malicious symbol shadowing and the symbols shadowed by <code class="language-plaintext highlighter-rouge">libm</code> and <code class="language-plaintext highlighter-rouge">libc</code> are well
known. In fact, on many systems, <code class="language-plaintext highlighter-rouge">libm</code> is a symlink to <code class="language-plaintext highlighter-rouge">libc</code>.</p>

<p>I have <a href="https://arxiv.org/abs/2211.05118">previously written</a> about through the development of <a href="https://github.com/fzakaria/shrinkwrap">shrinkwrap</a> that a more
annoying shadowing can happen with OpenMPI. It’s pretty easy to accidentally get the <em>no-op</em> library implementation earlier in
breadth-first search and find yourself with a sequential application.</p>

<p>I’ve included a neat <a href="https://github.com/fzakaria/sqlelf/blob/main/examples/shadowed-symbols/Makefile">example</a> in the sqlelf repository that you can play with
to test shadowing symbols and see the results of sqlelf. 🕵️</p>

<p>If you find any of this fascinating, contribute and let’s work to make accessing ELF via SQL simple and productive.</p>


<hr />
    </article>
</div>

<div class="sidebar">
    <hr class="visible-xs" />
    <img class="avatar" src="/assets/images/avatar-164.png" alt="A photo of my dog Moose" title="My dog Moose"/>
    <p>I'm a software engineer, father and wishful amateur surfer. If you've come seeking my political views; you've found the wrong <a href="https://fareedzakaria.com/">Fareed</a>.</p>
    <div class="external-links">
      <p>
        <span class="context">linkedin</span>
        <a href="https://www.linkedin.com/in/fmzakari/">fmzakari</a>
      </p>
      <p>
        <span class="context">github</span>
        <a href="https://github.com/fzakaria">fzakaria</a>
      </p>
      <p>
        <span class="context">email</span>
        <a href="mailto:farid.m.zakaria@gmail.com">farid.m.zakaria@gmail.com</a>
      </p>
      <p>
        <span class="context">pgp</span>
        <a href="/publickey.txt">D1B232E7</a>
      </p>
      <p>
        <a href="/archive">Archive</a>
      </p>
      <p>
        <a href="/old_blog/">Historic WordPress Blog</a>
      </p>
      <!--
      <p>
        Web friendly version of my <a href="/resume/index.html">resume</a>.
      </p>
    </div>
    <h3>Projects</h3>
    <p>
      <a href="/projects/">Click here</a> for some personal
      projects I've worked on.
    </p>
    <h3>Old Blog</h3>
    <p>
      <a href="/old_blog/">Click here</a> for the archive
      of my old blog posts from Wordpress.
    </p>
    -->
    
    <h3>Recent Posts</h3>
    
    <div class="post-stub">
      2025-02-02<br />
      <a href="/2025/02/02/nix-string-interpolation-of-directories-gone-awry.html">Nix: string interpolation of directories gone awry</a>
    </div>
    
    <div class="post-stub">
      2025-01-28<br />
      <a href="/2025/01/28/bazel-build-event-protocol-viewer.html">Bazel: Build Event Protocol Viewer</a>
    </div>
    
    <div class="post-stub">
      2025-01-12<br />
      <a href="/2025/01/12/bazel-knowledge-be-mindful-of-build-without-the-bytes.html">Bazel Knowledge: Be mindful of Build Without the Bytes (bwob)</a>
    </div>
    
    
    <h3>License</h3>
    <p style="font-size: 10pt">
    The content for this site is
    <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>.
    The <a href="https://github.com/SirCmpwn/ddjekyll">inspiration for the theme</a> for this site is
    © Drew Devault.
    </p>
    <div class="spacer" style="margin-top: 30px;"></div>
    
    <p><a href="https://github.com/fzakaria/fzakaria.com/edit/master/_posts/2023-09-11-quick-insights-using-sqlelf.md">
      Improve this page @ 417ff2d
    </a></p>

</div>
        </div>
    </body>
</html>
