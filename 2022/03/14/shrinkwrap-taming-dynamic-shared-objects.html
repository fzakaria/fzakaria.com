<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Shrinkwrap: Taming dynamic shared objects | Farid Zakaria‚Äôs Blog</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Shrinkwrap: Taming dynamic shared objects" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is a blog post of a paper I have submitted for a UCSC course project. If you are interested in the code check out https://github.com/fzakaria/shrinkwrap One of the fundamental data management units within a Linux system are the shared object files that are loaded into memory by dynamically linked processes at startup. The mechanism and approach to which dynamic linking is done has not changed since it‚Äôs inception however software has become increasingly complex." />
<meta property="og:description" content="This is a blog post of a paper I have submitted for a UCSC course project. If you are interested in the code check out https://github.com/fzakaria/shrinkwrap One of the fundamental data management units within a Linux system are the shared object files that are loaded into memory by dynamically linked processes at startup. The mechanism and approach to which dynamic linking is done has not changed since it‚Äôs inception however software has become increasingly complex." />
<link rel="canonical" href="https://fzakaria.com/2022/03/14/shrinkwrap-taming-dynamic-shared-objects.html" />
<meta property="og:url" content="https://fzakaria.com/2022/03/14/shrinkwrap-taming-dynamic-shared-objects.html" />
<meta property="og:site_name" content="Farid Zakaria‚Äôs Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-03-14T18:53:00-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Shrinkwrap: Taming dynamic shared objects" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-03-14T18:53:00-07:00","datePublished":"2022-03-14T18:53:00-07:00","description":"This is a blog post of a paper I have submitted for a UCSC course project. If you are interested in the code check out https://github.com/fzakaria/shrinkwrap One of the fundamental data management units within a Linux system are the shared object files that are loaded into memory by dynamically linked processes at startup. The mechanism and approach to which dynamic linking is done has not changed since it‚Äôs inception however software has become increasingly complex.","headline":"Shrinkwrap: Taming dynamic shared objects","mainEntityOfPage":{"@type":"WebPage","@id":"https://fzakaria.com/2022/03/14/shrinkwrap-taming-dynamic-shared-objects.html"},"url":"https://fzakaria.com/2022/03/14/shrinkwrap-taming-dynamic-shared-objects.html"}</script>
<!-- End Jekyll SEO tag -->

        <link type="application/atom+xml" rel="alternate" href="https://fzakaria.com/feed.xml" title="Farid Zakaria&apos;s Blog" />
        <link rel="stylesheet" type="text/css" href="/assets/css/base.css">
        <link rel="icon" type="image/x-icon" href="/assets/images/avatar.ico">
        <link rel="alternate" type="application/atom+xml" title="Farid Zakaria's Blog" href="/feed.xml">

        <link ref="">

        
        

        
            <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-35360900-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-35360900-1');
</script>

        

    </head>
    <body>
        

        <div class="container">
            <h1 class="page-title">
    <a class="rss pull-right" href="/feed.xml"><i class="fa fa-rss"></i></a>
    Shrinkwrap: Taming dynamic shared objects
</h1>

<div class="content">
    
    <p class="date">
        Published 2022-03-14
        on <a href="/">Farid Zakaria's Blog</a>
        <span class="hidden-xs">
          &mdash;
          <a href="/2022/03/14/shrinkwrap-taming-dynamic-shared-objects.html">
            Permalink
          </a>
        </span>
    </p>
    
    <article>
      <blockquote>
  <p>This is a blog post of a paper I have submitted for a <a href="https://catalog.ucsc.edu/en/Current/General-Catalog/Courses/CSE-Computer-Science-and-Engineering/Graduate/CSE-215">UCSC course</a> project.</p>

  <p>If you are interested in the code check out <a href="https://github.com/fzakaria/shrinkwrap">https://github.com/fzakaria/shrinkwrap</a></p>
</blockquote>

<p>One of the fundamental data management units within a Linux system are the shared object files that are loaded into memory by dynamically linked
processes at startup. The mechanism and approach to which dynamic linking is done has <strong>not changed</strong> since it‚Äôs inception however software has become
increasingly complex.</p>

<!--more-->

<p><em>This is the full build and run closure for Ruby in Nix, which is a good visual depiction of the complexity.</em>
<img src="/assets/images/ruby_full_closure.png" alt="Ruby closure" /></p>

<p>The discovery of the needed dependencies can at most be controlled by small set of directory lists or typically rely on convention for discovery, better known as the <a href="https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard">Filesystem Hierarchy Standard (FHS)</a>.</p>

<p>The reliance on convention for discovery of shared objects while simple, has resulted in challenges when trying to rebuild solutions reproducibly and
root cause discrepancies between machines ‚Äì <em>‚ÄúIt works on my machine but not yours‚Äù</em>.</p>

<p>Novel new software packaging models have emerged such as <a href="https://nixos.org/">Nix</a>, <a href="https://guix.gnu.org/">Guix</a> and <a href="https://spack.io/">Spack</a>, that attempt to tame the chaos of dependency hell by eschewing all uses of the FHS and relying on explicit deterministic paths. These tools have made great strides in moving software packaging to becoming more reproducible but still exhibit certain flaws, specifically
performance, as a result of building upon tooling that was designed for a different paradigm.</p>

<p><a href="https://github.com/fzakaria/shrinkwrap">Shrinkwrap</a> is a tool that attempts to overcome some of the performance limitations with how software may be packed in store-like models by <strong>freezing the dependencies</strong> directly on the executable.</p>

<blockquote>
  <p>For a different approach to this problem, check out <a href="https://guix.gnu.org/blog/2021/taming-the-stat-storm-with-a-loader-cache/">this blog post</a> by the Guix developers.</p>
</blockquote>

<p>The number of dependencies needed for a particular binary transitively, and the <code class="language-plaintext highlighter-rouge">RUNPATH</code> can vary greatly. For instance, <em>emacs</em> lists 36 directories in it‚Äôs <code class="language-plaintext highlighter-rouge">RUNPATH</code> and requires 103 dependencies to be resolved.</p>

<p>The result is that the dynamic linker must attempt potentially 3600 filesystem operations (openat or stat) to resolve the needed dependencies <strong>every time the process is started</strong>.</p>

<p>üêå This exorbitant cost can be made worse if the store itself resides on a shared filesystem such as NFS. üêå</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>patchelf <span class="nt">--print-rpath</span> /nix/store/vvxcs4f8x14gyahw50ssff3sk2dij2b3-emacs-27.2/bin/.emacs-27.2-wrapped <span class="se">\</span>
<span class="go">    | tr ':' '\n' | wc -l
36

</span><span class="gp">$</span><span class="w"> </span>ldd /nix/store/vvxcs4f8x14gyahw50ssff3sk2dij2b3-emacs-27.2/bin/.emacs-27.2-wrapped | <span class="nb">wc</span> <span class="nt">-l</span>
<span class="go">103
</span></code></pre></div></div>

<p>üí° When faced with a recurring problem, often the solution is to cache the previous answer to avoid unnecessary work.</p>

<p>Shrinkwrap adopts this approach by freezing the required dependencies directly into the <code class="language-plaintext highlighter-rouge">DT_NEEDED</code> section of the binary by having it point to an absolute path. The
transitive dependency list is also lifted to the top-level binary to simplify auditing the required dependencies.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>patchelf <span class="nt">--print-needed</span> /nix/store/zb2h75vbhg7w42b3f42bl0y2d4m0a4n3-emacs-27.1/bin/.emacs-27.1-wrapped
<span class="go">libtiff.so.5
libjpeg.so.62
libpng16.so.16
libz.so.1
libungif.so.4
libXpm.so.4
libgtk-3.so.0
libgdk-3.so.0

</span><span class="gp">$</span><span class="w"> </span>shrinkwrap /nix/store/zb2h75vbhg7w42b3f42bl0y2d4m0a4n3-emacs-27.1/bin/.emacs-27.1-wrapped <span class="nt">-o</span> emacs_stamped
<span class="go">
</span><span class="gp">$</span><span class="w"> </span>patchelf <span class="nt">--print-needed</span> emacs_stamped
<span class="go">/nix/store/2nkjrh3za68vrw6kf8lxn6nq1dval05v-gcc-10.3.0-lib/lib/libstdc++.so.6
/nix/store/jvbyjnjh4w8qg7izfq4x5d2wy9lv9461-icu4c-70.1/lib/libicudata.so.70
/nix/store/2kzsm8hhc4lzji6g1ksav9bdjbbiyxln-libgpg-error-1.42/lib/libgpg-error.so.0
/nix/store/mpwncqr8fbqflmglkrxj7a288xdbymk3-util-linux-2.37.2-lib/lib/libblkid.so.1
/nix/store/8n6mjngkw6909rx631rzwby2rsdk0blf-libglvnd-1.3.4/lib/libGLX.so.0
/nix/store/8n6mjngkw6909rx631rzwby2rsdk0blf-libglvnd-1.3.4/lib/libGLdispatch.so.0
/nix/store/xlvnyyviqcjys8if5hgkyykgv7d10hb8-libdatrie-2019-12-20-lib/lib/libdatrie.so.1
/nix/store/2zl3dw54ysdf55hngapkkfhiw0w8c9gp-json-glib-1.6.6/lib/libjson-glib-1.0.so.0
/nix/store/30q5xa4pfbvic54nh68qn86w6kjki66i-sqlite-3.36.0/lib/libsqlite3.so.0
/nix/store/jvbyjnjh4w8qg7izfq4x5d2wy9lv9461-icu4c-70.1/lib/libicui18n.so.70
/nix/store/jvbyjnjh4w8qg7izfq4x5d2wy9lv9461-icu4c-70.1/lib/libicuuc.so.70
</span></code></pre></div></div>

<p>Applying Shrinkwrap resulted in a large reduction in syscalls, which equates to a <strong>36x speedup</strong>. The absolute amount
recovered may seem negligible however this unnecessary penalty is paid on every process invocation, and on every machine executing the binary.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Program</th>
      <th style="text-align: center">Calls(stat/openat)</th>
      <th style="text-align: center">Time (Seconds)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">emacs</td>
      <td style="text-align: center">1823</td>
      <td style="text-align: center">0.034121</td>
    </tr>
    <tr>
      <td style="text-align: center">emacs_stamped</td>
      <td style="text-align: center">104</td>
      <td style="text-align: center">0.000950</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>The above was captured using <code class="language-plaintext highlighter-rouge">strace ‚Äì strace -e openat,stat -c ./emacs_stamped --version</code></p>
</blockquote>

<p>Shrinkwrap relies on the ability for a dynamic linker to deduplicate libraries with a common basename or whose soname (ELF header value) are the same. For instance in the below image, Shrinkwrap elevated <code class="language-plaintext highlighter-rouge">libac.so</code> to a direct absolute dependency of the binary, but relies on the dynamic linker deduplicating the resolution for <code class="language-plaintext highlighter-rouge">libxyz.so</code> which does not refer to it absolutely.</p>

<p><img src="/assets/images/glibc_dedupe.png" alt="glibc dedupe" /></p>

<p>‚ö†Ô∏è This functionality currently does not exist in <em>musl</em> and only works with <em>glibc</em>. ‚ö†Ô∏è</p>

<blockquote>
  <p>Please see <a href="https://www.openwall.com/lists/musl/2021/12/21/1">this mailing list discussion</a> for more details with <em>musl</em>.</p>
</blockquote>

<p>Nothing in Shrinkwrap assumes any Nix specifics and it may also be integrated into other store-like systems as well such as Guix and Spack.</p>

<p>It is not yet integrated into Nixpkgs but I would love feedback. üòä</p>

<h2 id="philosophical-questions">Philosophical Questions</h2>

<p>Changing the needed dynamic dependencies to point to absolute paths, especially when those paths are immutable and content-addressable, may
have philosophical and legal considerations for certain open-source licenses such as <em>LGPL</em>.</p>

<p>LGPL specifically mentions that only in the case of dynamic linking is the license not propagated over. Although these dependencies go through the process of being dynamically linked, the library they are linked
to is effectively fixed.</p>

<p><em>Does this distinction blur the differentiation between static and dynamic linking?</em></p>

<p><em>What if the linker validated the content-address to also verify the library hasn‚Äôt been changed?</em></p>

<p>Additional investigation into the legal ramifications may be an opportunity for future work.</p>


<hr />
    </article>
</div>

<div class="sidebar">
    <hr class="visible-xs" />
    <img class="avatar" src="/assets/images/avatar-164.png" alt="A photo of my dog Moose" title="My dog Moose"/>
    <p>I'm a software engineer, father and wishful amateur surfer. If you've come seeking my political views; you've found the wrong <a href="https://fareedzakaria.com/">Fareed</a>.</p>
    <div class="external-links">
      <p>
        <span class="context">linkedin</span>
        <a href="https://www.linkedin.com/in/fmzakari/">fmzakari</a>
      </p>
      <p>
        <span class="context">github</span>
        <a href="https://github.com/fzakaria">fzakaria</a>
      </p>
      <p>
        <span class="context">email</span>
        <a href="mailto:farid.m.zakaria@gmail.com">farid.m.zakaria@gmail.com</a>
      </p>
      <p>
        <span class="context">pgp</span>
        <a href="/publickey.txt">D1B232E7</a>
      </p>
      <p>
        <a href="/archive">Archive</a>
      </p>
      <p>
        <a href="/old_blog/">Historic WordPress Blog</a>
      </p>
      <!--
      <p>
        Web friendly version of my <a href="/resume/index.html">resume</a>.
      </p>
    </div>
    <h3>Projects</h3>
    <p>
      <a href="/projects/">Click here</a> for some personal
      projects I've worked on.
    </p>
    <h3>Old Blog</h3>
    <p>
      <a href="/old_blog/">Click here</a> for the archive
      of my old blog posts from Wordpress.
    </p>
    -->
    
    <h3>Recent Posts</h3>
    
    <div class="post-stub">
      2025-02-02<br />
      <a href="/2025/02/02/nix-string-interpolation-of-directories-gone-awry.html">Nix: string interpolation of directories gone awry</a>
    </div>
    
    <div class="post-stub">
      2025-01-28<br />
      <a href="/2025/01/28/bazel-build-event-protocol-viewer.html">Bazel: Build Event Protocol Viewer</a>
    </div>
    
    <div class="post-stub">
      2025-01-12<br />
      <a href="/2025/01/12/bazel-knowledge-be-mindful-of-build-without-the-bytes.html">Bazel Knowledge: Be mindful of Build Without the Bytes (bwob)</a>
    </div>
    
    
    <h3>License</h3>
    <p style="font-size: 10pt">
    The content for this site is
    <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>.
    The <a href="https://github.com/SirCmpwn/ddjekyll">inspiration for the theme</a> for this site is
    ¬© Drew Devault.
    </p>
    <div class="spacer" style="margin-top: 30px;"></div>
    
    <p><a href="https://github.com/fzakaria/fzakaria.com/edit/master/_posts/2022-03-14-shrinkwrap-taming-dynamic-shared-objects.md">
      Improve this page @ 417ff2d
    </a></p>

</div>
        </div>
    </body>
</html>
